<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ğŸ‘‰ Vue çš„åŒå‘ç»‘å®š | CHIEMINCHAN&#39;S BLOG</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/donut.png">
    <meta name="description" content="Hi, glad you came.">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.448d156c.js" as="script"><link rel="preload" href="/assets/js/2.fefa3fa1.js" as="script"><link rel="preload" href="/assets/js/1.67a15f5a.js" as="script"><link rel="preload" href="/assets/js/70.9061bb98.js" as="script"><link rel="prefetch" href="/assets/js/10.5229b01a.js"><link rel="prefetch" href="/assets/js/11.9dccb5a1.js"><link rel="prefetch" href="/assets/js/12.1aa023e7.js"><link rel="prefetch" href="/assets/js/13.da540175.js"><link rel="prefetch" href="/assets/js/14.981e669d.js"><link rel="prefetch" href="/assets/js/15.f28dd0b3.js"><link rel="prefetch" href="/assets/js/16.47e1d84d.js"><link rel="prefetch" href="/assets/js/17.7ff34030.js"><link rel="prefetch" href="/assets/js/18.6dcbdd16.js"><link rel="prefetch" href="/assets/js/19.e568fd00.js"><link rel="prefetch" href="/assets/js/20.182f1f9b.js"><link rel="prefetch" href="/assets/js/21.b834a74a.js"><link rel="prefetch" href="/assets/js/22.a3523cd2.js"><link rel="prefetch" href="/assets/js/23.61d15c5b.js"><link rel="prefetch" href="/assets/js/24.2aadb209.js"><link rel="prefetch" href="/assets/js/25.836695fb.js"><link rel="prefetch" href="/assets/js/26.0ab922cb.js"><link rel="prefetch" href="/assets/js/27.5ac9e339.js"><link rel="prefetch" href="/assets/js/28.d6a5eb15.js"><link rel="prefetch" href="/assets/js/29.3eea682e.js"><link rel="prefetch" href="/assets/js/3.fc739620.js"><link rel="prefetch" href="/assets/js/30.5225944d.js"><link rel="prefetch" href="/assets/js/31.ec02d3da.js"><link rel="prefetch" href="/assets/js/32.bd05dede.js"><link rel="prefetch" href="/assets/js/33.4a293dcf.js"><link rel="prefetch" href="/assets/js/34.4464026b.js"><link rel="prefetch" href="/assets/js/35.4dd4f327.js"><link rel="prefetch" href="/assets/js/36.ca28dda7.js"><link rel="prefetch" href="/assets/js/37.3a17971f.js"><link rel="prefetch" href="/assets/js/38.f86fa51b.js"><link rel="prefetch" href="/assets/js/39.6ff149b0.js"><link rel="prefetch" href="/assets/js/4.0471e9ae.js"><link rel="prefetch" href="/assets/js/40.23565895.js"><link rel="prefetch" href="/assets/js/41.0116a1ec.js"><link rel="prefetch" href="/assets/js/42.c38f3e0c.js"><link rel="prefetch" href="/assets/js/43.1d0d8ffd.js"><link rel="prefetch" href="/assets/js/44.631fa43e.js"><link rel="prefetch" href="/assets/js/45.0f88df1f.js"><link rel="prefetch" href="/assets/js/46.cc671ab0.js"><link rel="prefetch" href="/assets/js/47.90cce12d.js"><link rel="prefetch" href="/assets/js/48.ad0ce6a4.js"><link rel="prefetch" href="/assets/js/49.ade35f37.js"><link rel="prefetch" href="/assets/js/5.5356be46.js"><link rel="prefetch" href="/assets/js/50.de00c31b.js"><link rel="prefetch" href="/assets/js/51.9de8257a.js"><link rel="prefetch" href="/assets/js/52.50f1abf2.js"><link rel="prefetch" href="/assets/js/53.b3b3acb2.js"><link rel="prefetch" href="/assets/js/54.71bfe1b2.js"><link rel="prefetch" href="/assets/js/55.b00cfb1c.js"><link rel="prefetch" href="/assets/js/56.1bb058d3.js"><link rel="prefetch" href="/assets/js/57.5651fd65.js"><link rel="prefetch" href="/assets/js/58.3dd11306.js"><link rel="prefetch" href="/assets/js/59.233d45e8.js"><link rel="prefetch" href="/assets/js/6.5b3d5499.js"><link rel="prefetch" href="/assets/js/60.7c729149.js"><link rel="prefetch" href="/assets/js/61.eb5805f6.js"><link rel="prefetch" href="/assets/js/62.fde12179.js"><link rel="prefetch" href="/assets/js/63.3358d1e0.js"><link rel="prefetch" href="/assets/js/64.1b930210.js"><link rel="prefetch" href="/assets/js/65.3048ba53.js"><link rel="prefetch" href="/assets/js/66.a065502e.js"><link rel="prefetch" href="/assets/js/67.715eef17.js"><link rel="prefetch" href="/assets/js/68.edf44196.js"><link rel="prefetch" href="/assets/js/69.94cb6d60.js"><link rel="prefetch" href="/assets/js/7.c94df317.js"><link rel="prefetch" href="/assets/js/71.980c8e32.js"><link rel="prefetch" href="/assets/js/72.43be58ba.js"><link rel="prefetch" href="/assets/js/73.e2f40377.js"><link rel="prefetch" href="/assets/js/74.9ef8a48c.js"><link rel="prefetch" href="/assets/js/75.b006fb40.js"><link rel="prefetch" href="/assets/js/76.311cf38f.js"><link rel="prefetch" href="/assets/js/77.2d4b2c6d.js"><link rel="prefetch" href="/assets/js/78.81fd1ead.js"><link rel="prefetch" href="/assets/js/79.01e24fba.js"><link rel="prefetch" href="/assets/js/80.b15cc1f3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.934ed2fb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">CHIEMINCHAN'S BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  æ–‡ç« 
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  çŸ¥è¯†ç¢ç‰‡
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  ç®—æ³•
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  è¯»/è§‚åæ„Ÿ
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHubé¦–é¡µ
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  æ–‡ç« 
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  çŸ¥è¯†ç¢ç‰‡
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  ç®—æ³•
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  è¯»/è§‚åæ„Ÿ
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHubé¦–é¡µ
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DesignPatterns</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Microapp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Project Management</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html" class="active sidebar-link">ğŸ‘‰ Vue çš„åŒå‘ç»‘å®š</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#object-defineproperty-æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„" class="sidebar-link">Object.defineProperty()æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#ç®€è¿°" class="sidebar-link">ç®€è¿°</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#å®ç°æ€è·¯" class="sidebar-link">å®ç°æ€è·¯</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#å®ç°ä»£ç " class="sidebar-link">å®ç°ä»£ç </a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#observer" class="sidebar-link">Observer</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#dep" class="sidebar-link">Dep</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#watcher" class="sidebar-link">Watcher</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#compile" class="sidebar-link">Compile</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#mvvm" class="sidebar-link">MVVM</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#vue3-x-å“åº”å¼æ•°æ®åŸç†" class="sidebar-link">Vue3.x å“åº”å¼æ•°æ®åŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#vue2-x-çš„å“åº”è§„åˆ™" class="sidebar-link">Vue2.x çš„å“åº”è§„åˆ™</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#vue3-x-çš„-proxy" class="sidebar-link">Vue3.x çš„ proxy</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#proxy-ä»£ç†å¯¹è±¡æ˜¯æ•°ç»„æ—¶-å¤šæ¬¡è§¦å‘-set-get-å¦‚ä½•ä¼˜åŒ–" class="sidebar-link">Proxy ä»£ç†å¯¹è±¡æ˜¯æ•°ç»„æ—¶ï¼Œå¤šæ¬¡è§¦å‘ set / getï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/articles/Vue/Vue çš„åŒå‘ç»‘å®š.html#proxy-æ·±åº¦ä¾¦æµ‹æ•°æ®" class="sidebar-link">Proxy æ·±åº¦ä¾¦æµ‹æ•°æ®</a></li></ul></li></ul></li><li><a href="/articles/Vue/diff ç®—æ³•.html" class="sidebar-link">ğŸ‘‰ diff ç®—æ³•</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-çš„åŒå‘ç»‘å®š"><a href="#vue-çš„åŒå‘ç»‘å®š" class="header-anchor">#</a> ğŸ‘‰ Vue çš„åŒå‘ç»‘å®š</h1> <p>Vue.js ä¸»è¦é‡‡ç”¨<strong>æ•°æ®åŠ«æŒ</strong>ç»“åˆ<strong>å‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼</strong>çš„æ–¹å¼ï¼Œé€šè¿‡<code>Object.defineProperty()</code>æ¥åŠ«æŒå„ä¸ªå±æ€§çš„ setterï¼Œgetterï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œç„¶åè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚</p> <h2 id="object-defineproperty-æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„"><a href="#object-defineproperty-æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„" class="header-anchor">#</a> Object.defineProperty()æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„</h2> <p><code>Object.defineProperty</code> å¯ä»¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰æ–°å±æ€§æˆ–ä¿®æ”¹ç°æœ‰å±æ€§ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨äºæ§åˆ¶ä¸€ä¸ªå¯¹è±¡å±æ€§çš„ä¸€äº›ç‰¹æœ‰æ“ä½œï¼Œæ¯”å¦‚è¯»å†™æƒã€æ˜¯å¦å¯ä»¥æšä¸¾ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span> <span class="token string">&quot;property1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;i am property1&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// ä¸å¯å†™</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj1<span class="token punctuation">.</span>property1 <span class="token operator">=</span> <span class="token string">&quot;i has changed&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {property1: &quot;i am property1&quot;}</span>
</code></pre></div><p>è¿™é‡Œå…ˆç®€å•äº†è§£ä¸€ä¸‹<code>Object.defineProperty</code>çš„ä¸¤ä¸ªæè¿°å±æ€§ get å’Œ set ç”¨æ³•ï¼š</p> <p>ä¸€ä¸ªç®€å•çš„æ —å­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> book1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>book1<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> val<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;å°† book1 å–åä¸ºï¼š&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ã€Š&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;ã€‹&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

book1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;é”¦é²¤&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;è·å– book1 çš„ä¹¦åï¼š&quot;</span><span class="token punctuation">,</span> book1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å°† book1 å–åä¸ºï¼š é”¦é²¤</span>
<span class="token comment">// è·å– book1 çš„ä¹¦åï¼šã€Šé”¦é²¤ã€‹</span>
</code></pre></div><h2 id="ç®€è¿°"><a href="#ç®€è¿°" class="header-anchor">#</a> ç®€è¿°</h2> <p>Vue åœ¨åˆå§‹åŒ–æ•°æ®çš„æ—¶å€™ï¼Œé€šè¿‡ Object.defineProperty çš„ getterï¼ˆæ•°æ®ä¾èµ–æ”¶é›†å¤„ç†ï¼‰ å’Œ setterï¼ˆç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œå¹¶é€šçŸ¥è®¢é˜…ï¼‰ å¯¹ data é‡Œé¢çš„æ¯ä¸ªå±æ€§å¯¹è±¡è¿›è¡ŒåŠ«æŒç›‘å¬å’Œå±æ€§ä»£ç†ã€‚</p> <p>å½“é¡µé¢ä½¿ç”¨å¯¹åº”å±æ€§æ—¶ï¼Œé¦–å…ˆä¼šé€šè¿‡ Dep è¿›è¡Œä¾èµ–æ”¶é›†(æ”¶é›† Watcher) ï¼›å¦‚æœå±æ›´æ–°äº†ï¼Œä¼šé€šçŸ¥ç›¸å…³çš„ä¾èµ–è¿›è¡Œæ›´æ–°æ“ä½œ(å‘å¸ƒè®¢é˜…) ã€‚</p> <p>è¿‡ç¨‹ï¼š</p> <p>ï¼ˆ1ï¼‰åˆæ¬¡æ¸²æŸ“ï¼Œæ ¹æ®ä¼ å…¥çš„ data å’Œ render å‡½æ•°ï¼Œç”Ÿæˆå¯¹åº”çš„ VNode Treeã€‚</p> <p>è¿™æœŸé—´ä¼šæœ‰ä¸€æ¬¡ä¾èµ–æ”¶é›†è¿‡ç¨‹ï¼Œå»ºç«‹ä¸€ä¸ªç›´æ¥å¯¹åº” render çš„ Watcherï¼Œä¸” <code>v-if</code> ä¸º false çš„å…ƒç´ ä¸ä¼šå‡ºç°åœ¨ç”Ÿæˆçš„ VNode Tree ä¸­ï¼Œæœ€åè°ƒç”¨ patchï¼Œå› ä¸ºæ²¡æœ‰ oldVnode, ä¼šç›´æ¥å°† VNode æ¸²æŸ“ä¸ºçœŸå®çš„ DOMã€‚</p> <p>ï¼ˆ2ï¼‰æ–°å»ºå®ä¾‹æ—¶ï¼Œvue ä¼šè°ƒç”¨ Compile å°† el è½¬æ¢æˆ VNodeï¼ˆè§£æ new Vue ä¼ å…¥çš„ el æˆ– template å…ƒç´ ä¸­çš„å…ƒç´ ï¼Œç”Ÿæˆ AST æ ‘ï¼Œè¿”å›æ„å»ºè™šæ‹ŸèŠ‚ç‚¹ VNodeï¼‰ï¼›</p> <p>ï¼ˆ3ï¼‰å¼€å§‹ç›‘å¬æ•°æ®å˜åŒ–ï¼Œåˆ›å»º propsã€data çš„é’©å­ä»¥åŠå…¶å¯¹è±¡æˆå‘˜çš„ Observerï¼ŒåŒæ—¶è¿›è¡Œ data çš„å±æ€§ä»£ç†ï¼›</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// new Vue æ‰§è¡Œæµç¨‹ã€‚</span>
    <span class="token comment">// 1. Vue.prototype._init(option)</span>
    <span class="token comment">// 2. vm.$mount(vm.$options.el)</span>
    <span class="token comment">// 3. render = compileToFunctions(template) ï¼Œç¼–è¯‘ Vue ä¸­çš„ template æ¨¡æ¿ï¼Œç”Ÿæˆ render æ–¹æ³•ã€‚</span>
    <span class="token comment">// 4. Vue.prototype.$mount è°ƒç”¨ä¸Šé¢çš„ render æ–¹æ³•æŒ‚è½½ domã€‚</span>
    <span class="token comment">// 5. mountComponent</span>

    <span class="token comment">// 6. åˆ›å»º Watcher å®ä¾‹</span>
    <span class="token comment">// ç»“åˆä¸Šæ–‡ï¼Œæˆ‘ä»¬å°±èƒ½å¾—å‡ºï¼ŒupdateComponent å°±æ˜¯ä¼ å…¥ Watcher å†…éƒ¨çš„ getter æ–¹æ³•ã€‚</span>
    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. new Watcher ä¼šæ‰§è¡Œ Watcher.get æ–¹æ³•</span>
    <span class="token comment">// 8. Watcher.get ä¼šæ‰§è¡Œ this.getter.call(vm, vm) ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ updateComponent æ–¹æ³•</span>

    <span class="token comment">// 9. updateComponent ä¼šæ‰§è¡Œ vm._update(vm._render())</span>
    <span class="token keyword">function</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†ç”Ÿæˆçš„JSæ¨¡ç‰ˆå½“å‚æ•°ä¼ é€’</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 10.è°ƒç”¨ vm._render ä¼šç”Ÿæˆè™šæ‹Ÿ dom</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
    <span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 11. è°ƒç”¨ vm._update(vnode) æ¸²æŸ“è™šæ‹Ÿ dom</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// ä¸Šä¸€æ¬¡æ›´æ–°çš„vnode</span>
    <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">;</span>

    <span class="token comment">// ä¸‹ä¸€æ¬¡å¯¹æ¯”çš„vnode</span>
    vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œåˆæ¬¡æ¸²æŸ“</span>
        vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ›´æ–°</span>
        vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 12. vm.__patch__ æ–¹æ³•å°±æ˜¯åšçš„ dom diff æ¯”è¾ƒï¼Œç„¶åæ›´æ–° domã€‚</span>
</code></pre></div><p>ï¼ˆ4ï¼‰ä¹‹åï¼Œæ¯å½“å±æ€§æ›´æ–°æ—¶ï¼Œéƒ½å°†é€šçŸ¥ç›¸åº”çš„ watcher æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ›´æ–°è§†å›¾ï¼š<br>
a. å½“ç»™è¿™ä¸ªå¯¹è±¡çš„æŸå±æ€§èµ‹å€¼æ—¶ï¼Œå°±ä¼šè§¦å‘ set æ–¹æ³•ï¼›<br>
b. set å‡½æ•°è°ƒç”¨ï¼Œè§¦å‘å±æ€§æ¶ˆæ¯å™¨ Dep çš„ notify å‘å¯¹åº”çš„ watcher é€šçŸ¥å˜åŒ–ï¼›<br>
c. watcher è°ƒç”¨ upddate æ–¹æ³•æ›´æ–°è§†å›¾ã€‚</p> <h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="header-anchor">#</a> å®ç°æ€è·¯</h2> <p>è¦å®ç°å“åº”å¼ï¼ˆ MVVM çš„åŒå‘ç»‘å®šï¼‰ï¼Œä¸»è¦éœ€è¦å®ç°ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š<br>
ï¼ˆ1ï¼‰<strong>Observe</strong>ï¼šæ•°æ®ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬æ•°æ®å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œæœ‰å˜åŠ¨æ—¶è·å–æœ€æ–°å€¼å¹¶é€šçŸ¥è®¢é˜…è€…ï¼›</p> <p>ï¼ˆ2ï¼‰<strong>Dep</strong>å’Œ<strong>Watcher</strong>ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…ï¼Œè¿æ¥ Observe å’Œ Compileï¼Œç”¨äºè®¢é˜…å¹¶ä¸”æ¥æ”¶åˆ°æ¯ä¸ªå±æ€§å˜åŠ¨çš„æ¶ˆæ¯ï¼Œå¹¶è§¦å‘è§£æå™¨ä¸­ç»‘å®šçš„ç›¸åº”å›è°ƒå‡½æ•°ï¼Œä»è€Œè·Ÿæ–°è§†å›¾ã€‚</p> <p>ï¼ˆ3ï¼‰<strong>Compile</strong>ï¼šæŒ‡ä»¤è§£æå™¨ï¼Œç”¨äºå¯¹æ¯ä¸ªå…ƒç´ èŠ‚ç‚¹æŒ‡ä»¤çš„æ‰«æå’Œè§£æï¼Œä»¥åŠç»‘å®šå¯¹åº”çš„å›è°ƒå‡½æ•°ï¼›</p> <p>ï¼ˆ4ï¼‰<strong>MVVM</strong> å…¥å£å‡½æ•°</p> <h2 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="header-anchor">#</a> å®ç°ä»£ç </h2> <h3 id="observer"><a href="#observer" class="header-anchor">#</a> Observer</h3> <p>Observer çš„ä¸»è¦åŠŸèƒ½æ˜¯ç›‘å¬æ•°æ®å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œé€šè¿‡éå†æ‰€æœ‰å±æ€§ï¼Œä¸ºå±æ€§æ·»åŠ è®¢é˜…è€…ï¼Œå¹¶åœ¨å±æ€§å‘ç”Ÿå˜åŒ–åé€šçŸ¥è®¢é˜…è€…ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Observer</span>
<span class="token keyword">const</span> <span class="token function-variable function">Observer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mapToConvet</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">observer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Observer</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> Observer<span class="token punctuation">,</span>

    <span class="token function-variable function">mapToConvet</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

        <span class="token comment">// éå†æ¯ä¸ªå±æ€§è¿›è¡Œç›‘å¬</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            _this<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">defineReactive</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç›‘å¬å­å±æ€§</span>
        <span class="token keyword">let</span> childObj <span class="token operator">=</span> <span class="token function">observer</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// å¯æšä¸¾</span>
            <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// ä¸èƒ½å†define</span>
            <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// éœ€è¦ä¸ºå±æ€§æ·»åŠ è®¢é˜…è€…ï¼Œè€Œè®¢é˜…è€…æ˜¯Watcherï¼Œå› æ­¤éœ€è¦åœ¨é—­åŒ…å†…æ·»åŠ  watcherï¼Œæ‰€ä»¥é€šè¿‡Depå®šä¹‰ä¸€ä¸ªå…¨å±€targetå±æ€§ï¼Œæš‚å­˜ watcher, æ·»åŠ å®Œç§»é™¤</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;get: &quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&quot; = &quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> val<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;change detected: &quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token string">&quot; -&gt; &quot;</span><span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>

                <span class="token comment">// æ–°çš„å€¼æ˜¯objectçš„è¯ï¼Œéœ€è¦è¿›è¡Œç›‘å¬</span>
                childObj <span class="token operator">=</span> <span class="token function">observer</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…</span>
                dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="dep"><a href="#dep" class="header-anchor">#</a> Dep</h3> <p>Dep ç›¸å½“äºå‘å¸ƒè€…çš„è§’è‰²ï¼Œä¸»è¦è´Ÿè´£æ”¶é›†è®¢é˜…è€…ï¼Œå¹¶åœ¨å±æ€§æ›´æ–°åè§¦å‘ notifyï¼Œå»é€šçŸ¥å¯¹åº”çš„è®¢é˜…è€…ï¼Œè°ƒç”¨è®¢é˜…è€…çš„ updateã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Dep</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//æ¯ä¸ªDepéƒ½æœ‰å”¯ä¸€çš„ID</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">//subsç”¨äºå­˜æ”¾ä¾èµ–</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ç”¨äºæš‚æ—¶ç¼“å­˜ watcher</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‘subsæ•°ç»„æ·»åŠ ä¾èµ–</span>
    <span class="token function-variable function">addSub</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// ç§»é™¤ä¾èµ–</span>
    <span class="token function-variable function">removeSub</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// è®¾ç½®æŸä¸ªWatcherçš„ä¾èµ–</span>
    <span class="token comment">// è¿™é‡Œæ·»åŠ äº†Dep.targetæ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ï¼Œç›®çš„æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯Watcherçš„æ„é€ å‡½æ•°è°ƒç”¨</span>
    <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´åˆ¤æ–­æ˜¯å¦é€šè¿‡çš„this.getè°ƒç”¨çš„ï¼Œè€Œä¸æ˜¯æ™®é€šè°ƒç”¨</span>
    <span class="token function-variable function">depend</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è§¦å‘watcherçš„addDep</span>
            Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">notify</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è°ƒç”¨è®¢é˜…è€…çš„updateæ–¹æ³•ï¼Œé€šçŸ¥å˜åŒ–</span>
            sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="watcher"><a href="#watcher" class="header-anchor">#</a> Watcher</h3> <p>Watcherï¼Œä½œä¸ºè®¢é˜…è€…ä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼š<br>
ï¼ˆ1ï¼‰éœ€è¦åœ¨è‡ªèº«å®ä¾‹åŒ–çš„æ—¶å€™å¾€å±æ€§è®¢é˜…å™¨é‡Œæ·»åŠ è‡ªå·±ï¼›<br>
ï¼ˆ2ï¼‰è‡ªèº«éœ€æœ‰ä¸€ä¸ª <code>update()</code> çš„æ–¹æ³•ï¼›<br>
ï¼ˆ3ï¼‰åœ¨å±æ€§å˜åŠ¨è§¦å‘å±æ€§è®¢é˜…å™¨ <code>dep.notice()</code> æ—¶ï¼Œèƒ½è°ƒç”¨è‡ªèº«çš„ <code>update()</code> æ–¹æ³•ï¼Œå¹¶ä¸”è¿›ä¸€æ­¥è§¦å‘ Compile ä¸­ç»‘å®šçš„æ›´æ–°å›è°ƒå‡½æ•°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
    @param vm èŠ‚ç‚¹
    @param exp èŠ‚ç‚¹æŒ‡ä»¤ç»‘å®šçš„å˜é‡å/å‡½æ•°äº‹ä»¶å
    @param cb èŠ‚ç‚¹æŒ‡ä»¤çš„æ›´æ–°å›è°ƒå‡½æ•°
    */</span>
<span class="token keyword">const</span> <span class="token function-variable function">Watcher</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> cb<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>exp <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span>

    <span class="token comment">// è‡ªå·±è¢«å“ªäº›è®¢é˜…æ”¶é›†å™¨ç»™æ”¶é›†</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depsIds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseGetter</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ­¤å¤„ä¸ºäº†è§¦å‘å±æ€§çš„getterï¼Œä»è€Œåœ¨depæ·»åŠ è‡ªå·±</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> Watcher<span class="token punctuation">,</span>

    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å½“å‰è®¢é˜…è€…æŒ‡å‘è‡ªå·±</span>
        <span class="token comment">// é€šè¿‡Dep.target = watcherInstanceæ ‡è®°è®¢é˜…è€…æ˜¯å½“å‰watcherå®ä¾‹ï¼Œå¼ºè¡Œè§¦å‘å±æ€§å®šä¹‰çš„getteræ–¹æ³•ï¼Œgetteræ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¼šåœ¨å±æ€§çš„è®¢é˜…å™¨depæ·»åŠ å½“å‰watcherå®ä¾‹ï¼Œä»è€Œåœ¨å±æ€§å€¼æœ‰å˜åŒ–çš„æ—¶å€™ï¼ŒwatcherInstanceå°±èƒ½æ”¶åˆ°æ›´æ–°é€šçŸ¥ã€‚</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

        <span class="token comment">// å¼ºåˆ¶è§¦å‘æ‰§è¡Œç›‘å¬å™¨é‡Œçš„getterï¼ŒæŠŠè‡ªå·±æ·»åŠ åˆ°å±æ€§è®¢é˜…å™¨ä¸­</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ·»åŠ å®Œæ¯•ï¼Œé‡Šæ”¾è‡ªå·±é‡ç½®</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">parseGetter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸åŒ¹é…å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹å·å’Œ$ç¬¦å·</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\w.$]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> exps <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> exps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
                obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>exps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">update</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// dep.notice()è§¦å‘é€šçŸ¥åæ‰§è¡Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">run</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> oldVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ›´æ–°æœ€æ–°å€¼</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> newVal<span class="token punctuation">;</span>

            <span class="token comment">// æ‰§è¡ŒCompileä¸­ç»‘å®šçš„å›è°ƒï¼Œæ›´æ–°è§†å›¾</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">addDep</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.æ¯æ¬¡è°ƒç”¨ run çš„æ—¶å€™éƒ½ä¼šè§¦å‘ç›¸åº”å±æ€§çš„getterï¼Œç„¶åè§¦å‘åˆ°è¿™é‡Œçš„addDepã€‚è¿›è€Œå¾€å±æ€§è®¢é˜…å™¨é‡Œé¢æ·»åŠ è‡ªå·±ï¼Œå¹¶å°†è¿™ä¸ªå±æ€§å‘å¸ƒè€…idå­˜è¿›depsIdé‡Œã€‚</span>

        <span class="token comment">// 2.å‡å¦‚ç›¸åº”å±æ€§çš„dep.idå·²å­˜åœ¨watcherçš„depIdsé‡Œï¼Œè¯´æ˜è¿™ä¸æ˜¯ä¸ªæ–°å±æ€§ï¼Œä»…éœ€æ”¹å˜å…¶å€¼ï¼Œè€Œä¸éœ€å°†å½“å‰watcheræ·»åŠ è‡³è¯¥å±æ€§çš„depé‡Œã€‚</span>
        <span class="token comment">// 3.å‡å¦‚ç›¸åº”å±æ€§æ˜¯æ–°çš„å±æ€§ï¼Œåˆ™å°†å½“å‰watcheræ·»åŠ åˆ°æ–°å±æ€§è®¢é˜…å™¨depé‡Œã€‚</span>

        <span class="token comment">// è‹¥é€šè¿‡ vm.child = {name: 'a'}ï¼Œæ”¹å˜äº† child.name çš„å€¼ï¼Œchild.nameå°±æ˜¯ä¸ªæ–°å±æ€§ï¼Œåˆ™éœ€è¦å°†å½“å‰ watcher(child.name) åŠ å…¥åˆ°æ–°çš„child.nameçš„depä¸­</span>
        <span class="token comment">// è‹¥é€šè¿‡ child.name = xxx è¿›è¡Œé‡æ–°èµ‹å€¼çš„æ—¶å€™ï¼Œå¯¹åº”çš„ watcher åˆ™ä¸ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œç­‰äºå¤±æ•ˆäº†</span>

        <span class="token comment">// 4.æ¯ä¸ªå­å±æ€§çš„ watcher æ·»åŠ åˆ°å­å±æ€§çš„ dep åŒæ—¶ï¼Œä¹Ÿä¼šæ·»åŠ åˆ°çˆ¶å±æ€§çš„ dep</span>
        <span class="token comment">// ç›‘å¬å­å±æ€§çš„åŒæ—¶ç›‘å¬çˆ¶å±æ€§çš„å˜æ›´ï¼Œè¿™æ ·å­çˆ¶å±æ€§æ”¹å˜æ—¶ï¼Œå­å±æ€§çš„ watcher ä¹Ÿèƒ½æ”¶åˆ°é€šçŸ¥è¿›è¡Œ update</span>
        <span class="token comment">// è¿™ä¸€æ­¥æ˜¯åœ¨ this.get() -&gt; this.getVMVal ä¸­å®Œæˆï¼ŒforEach æ—¶ä¼šä»çˆ¶çº§å¼€å§‹å–å€¼ï¼Œé—´æ¥è°ƒç”¨äº†å®ƒçš„ getterï¼Œè¿›è€Œè§¦å‘äº† addDep()</span>
        <span class="token comment">// addDep()ä¸­ï¼Œåœ¨æ•´ä¸ªforEachè¿‡ç¨‹ï¼Œå½“å‰wacheréƒ½ä¼šåŠ å…¥åˆ°æ¯ä¸ªçˆ¶çº§è¿‡ç¨‹å±æ€§çš„dep</span>

        <span class="token comment">// å¦‚ï¼š å½“å‰ wacther æ˜¯ child.child.nameï¼Œé‚£ä¹ˆ childã€child.childã€child.child.name è¿™ä¸‰ä¸ªå±æ€§çš„depéƒ½ä¼šåŠ å…¥å½“å‰watcher</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depsIds<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>depsIds<span class="token punctuation">[</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> dep<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="compile"><a href="#compile" class="header-anchor">#</a> Compile</h3> <p>å¯¹ template æ¨¡æ¿ä¸­è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆçœŸæ­£çš„ htmlï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­å¯¹ vue çš„æŒ‡ä»¤è§£æã€‚</p> <p>Compile ä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼š<br>
1ï¼‰ é¦–å…ˆæ˜¯æ·±åº¦éå† dom æ ‘ï¼Œéå†æ¯ä¸ªèŠ‚ç‚¹ä»¥åŠå­èŠ‚ç‚¹ï¼›<br>
2ï¼‰ è§£ææ¨¡æ¿æŒ‡ä»¤ï¼Œå°†æ¨¡æ¿çš„å˜é‡æ›¿æ¢æˆæ•°æ®ï¼Œç„¶ååˆå§‹åŒ–æ¸²æŸ“é¡µé¢è§†å›¾ï¼›<br>
3ï¼‰ æ·»åŠ ç›‘å¬æ•°æ®çš„è®¢é˜…è€…ï¼Œå°†æ¯ä¸ªæŒ‡ä»¤å¯¹åº”çš„èŠ‚ç‚¹ç»‘å®šæ›´æ–°å‡½æ•°ã€‚ä¸€æ—¦æ•°æ®æœ‰å˜åŠ¨ï¼Œæ”¶åˆ°é€šçŸ¥ï¼Œæ›´æ–°è§†å›¾ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">Compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isElementNode</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> el <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å› ä¸ºéå†è§£æè¿‡ç¨‹æœ‰å¤šæ¬¡æ“ä½œDOMèŠ‚ç‚¹ï¼Œä¸ºæé«˜æ€§èƒ½å’Œæ•ˆç‡ï¼Œä¼šå…ˆå°†vueå®ä¾‹æ ¹èŠ‚ç‚¹çš„ el è½¬æ¢æˆæ–‡æ¡£ç¢ç‰‡ fragments è¿›è¡Œè§£æç¼–è¯‘æ“ä½œï¼Œå†å°† fragments æ·»åŠ å›åŸæ¥çš„çœŸå®DomèŠ‚ç‚¹ä¸­</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$fragments <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nodeTofragments</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆå§‹åŒ–</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$fragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Compile</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> Compile<span class="token punctuation">,</span>

    <span class="token function-variable function">isElementNode</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// nodeType ä¸º 1 æ—¶ä»£è¡¨ä¸ºå…ƒç´  Element</span>
        <span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">isTextNode</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// nodeType ä¸º 3 æ—¶ä»£è¡¨ä¸ºå…ƒç´  Element</span>
        <span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">isDirective</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> attr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;v-&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">isEventDirective</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">directive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> directive<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$fragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">nodeTofragments</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fragments <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentfragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> child<span class="token punctuation">;</span>

        <span class="token comment">// å°†åŸç”ŸèŠ‚ç‚¹æ‹·è´åˆ° fragments</span>
        <span class="token comment">// while(child = el.firstChild) æ‰§è¡Œä¸¤ä¸ªæ“ä½œï¼š</span>
        <span class="token comment">// å…ˆæŠŠel.firstChildï¼ˆå³el.children[0]ï¼‰æŠ½å‡ºèµ‹å€¼ç»™childï¼Œç„¶åå°†childæ’å…¥è‡³fragmentsä¸­ã€‚</span>
        <span class="token comment">// è¿™ä¸ªæ“ä½œæ˜¯ç§»åŠ¨domï¼Œä¸€æ—¦el.children[0]è¢«æŠ½å‡ºï¼Œåœ¨ä¸‹æ¬¡å¾ªç¯æ‰§è¡Œchild = el.firstChildæ—¶ï¼Œè¯»å–çš„æ˜¯el.children[1]</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>child <span class="token operator">=</span> el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°†ä»æ–‡æ¡£æ ‘ä¸­åˆ é™¤ï¼Œç„¶åæŒ‰åºé‡æ–°æ’å…¥fragmentså½“å‰èŠ‚ç‚¹çš„ childNodes[] æ•°ç»„çš„æœ«å°¾</span>
            <span class="token comment">// ç›¸å½“äºæŠŠelä¸­èŠ‚ç‚¹ç§»åŠ¨è¿‡å»</span>
            fragments<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> fragments<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// éå†æ‰€æœ‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ï¼Œè¿›è¡Œæ‰«æè§£æç¼–è¯‘ï¼Œè°ƒç”¨å¯¹åº”çš„æŒ‡ä»¤æ¸²æŸ“å‡½æ•°è¿›è¡Œæ•°æ®æ¸²æŸ“ï¼Œå¹¶è°ƒç”¨å¯¹åº”æŒ‡ä»¤æ›´æ–°å‡½æ•°è¿›è¡Œç»‘å®š</span>
    <span class="token function-variable function">compileElement</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> childNodes <span class="token operator">=</span> el<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>

        <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–èŠ‚ç‚¹æ–‡æœ¬å†…å®¹</span>
            <span class="token keyword">const</span> text <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent<span class="token punctuation">;</span>

            <span class="token comment">// æ¨¡æ¿æ•°æ®åŒ¹é…æ­£åˆ™</span>
            <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.*)\}\}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

            <span class="token comment">// æ ¹æ®ä¸åŒèŠ‚ç‚¹ç±»å‹é€‰æ‹©ç¼–è¯‘æ–¹å¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span><span class="token function">isElementNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span><span class="token function">compileElementNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span><span class="token function">isTextNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span><span class="token function">compileTextNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// éå†ç¼–è¯‘å…¶å­èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">hasChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">compileElementNode</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> nodeAttrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nodeAttrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è§„å®šï¼šæŒ‡ä»¤ä»¥ v-xxx å‘½å</span>
            <span class="token comment">// å¦‚ï¼šv-on:click=&quot;open&quot;ã€v-text=&quot;content&quot;</span>
            <span class="token keyword">const</span> attrName <span class="token operator">=</span> attr<span class="token punctuation">.</span>name<span class="token punctuation">;</span>

            <span class="token comment">// å¤„ç†æŒ‡ä»¤å±æ€§</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span><span class="token function">isDirective</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æŒ‡ä»¤ç»‘å®šçš„å‡½æ•°äº‹ä»¶å</span>
                <span class="token keyword">const</span> exp <span class="token operator">=</span> attr<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

                <span class="token comment">// å¦‚ï¼šon:clickã€text</span>
                <span class="token keyword">const</span> directive <span class="token operator">=</span> attrName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// äº‹ä»¶æŒ‡ä»¤</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span><span class="token function">isEventDirective</span><span class="token punctuation">(</span>directive<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    compileUtils<span class="token punctuation">.</span><span class="token function">eventHandler</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> directive<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// æ™®é€šæŒ‡ä»¤</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    compileUtils<span class="token punctuation">[</span>directive<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
                        compileUtils<span class="token punctuation">[</span>directive<span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">compileTextNode</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compileUtils<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> compileUtils <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº‹ä»¶å¤„ç†</span>
    <span class="token function-variable function">eventHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> directive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> eventType <span class="token operator">=</span> directive<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> fn <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>exp<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType <span class="token operator">&amp;&amp;</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">model</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">&quot;model&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getVMVal</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> newVal <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            _this<span class="token punctuation">.</span><span class="token function">_setVMVal</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">text</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">bind</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> directive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> updaterFn <span class="token operator">=</span> updater<span class="token punctuation">[</span>directive <span class="token operator">+</span> <span class="token string">&quot;Updater&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// ç¬¬ä¸€æ¬¡åˆå§‹åŒ–è§†å›¾</span>
        updaterFn <span class="token operator">&amp;&amp;</span> <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getVMVal</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å®ä¾‹åŒ–è®¢é˜…è€…ï¼Œæ­¤æ“ä½œä¼šåœ¨å¯¹åº”çš„å±æ€§æ¶ˆæ¯è®¢é˜…å™¨ä¸­æ·»åŠ è¯¥è®¢é˜…è€… watcherInstance</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä¸€æ—¦å±æ€§å€¼æœ‰å˜åŒ–ï¼Œä¼šæ”¶åˆ°é€šçŸ¥æ‰§è¡Œæ­¤æ›´æ–°å‡½æ•°ï¼Œæ›´æ–°è§†å›¾</span>
            updaterFn <span class="token operator">&amp;&amp;</span> <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">_getVMVal</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> vm<span class="token punctuation">;</span>
        exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è·å–é“¾å¼è°ƒç”¨æœ€åä¸€ä¸ªäº‹ä»¶çš„å€¼??</span>
        exp<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            val <span class="token operator">=</span> val<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">_setVMVal</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> vm<span class="token punctuation">;</span>
        exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ‰§è¡Œé“¾å¼è°ƒç”¨æœ€åä¸€ä¸ªäº‹ä»¶å¹¶èµ‹å€¼</span>
        exp<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> exp<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                val <span class="token operator">=</span> val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‰§è¡Œæœ€åä¸€ä¸ªkeyï¼Œæ›´æ–°val</span>
                val<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// æ›´æ–°å‡½æ•°</span>
<span class="token keyword">const</span> updater <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">textUpdater</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">htmlUpdater</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">modelUpdater</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">classUpdater</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vlaue<span class="token punctuation">,</span> oldValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> className <span class="token operator">=</span> node<span class="token punctuation">.</span>className<span class="token punctuation">;</span>
        className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> space <span class="token operator">=</span> className <span class="token operator">&amp;&amp;</span> <span class="token function">String</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot; &quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>className <span class="token operator">=</span> className <span class="token operator">+</span> space <span class="token operator">+</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="mvvm"><a href="#mvvm" class="header-anchor">#</a> MVVM</h3> <p>MVVM æ˜¯æ•°æ®ç»‘å®šçš„å…¥å£ï¼Œæ•´åˆäº† Observeã€Compile å’Œ Watcher ä¸‰è€…ã€‚</p> <p>ç®€å•çš„ MVVM æ„é€ å™¨å®ç°æ˜¯ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">MVVM</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">;</span>
    <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// å±æ€§ä»£ç†ï¼Œå®ç° vm.xxx === vm._data.xxx</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span><span class="token function">_proxy</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initComputed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>$compile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compile</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>el <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">MVVM</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token constant">MVVM</span><span class="token punctuation">,</span>

    <span class="token comment">// é€šè¿‡ Object.defineProperty()æ¥åŠ«æŒvmå®ä¾‹å¯¹è±¡å±æ€§çš„è¯»å†™æƒé™ï¼Œä½¿å¾—å¯¹ vm.xxx çš„è¯»å†™éƒ½è½¬æˆ vm._data.xxxçš„æ–¹å¼</span>
    <span class="token function-variable function">_proxy</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> _this<span class="token punctuation">.</span>_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span>_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">_initComputed</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> computed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>computed<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> computed <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>computed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">get</span><span class="token operator">:</span>
                        <span class="token keyword">typeof</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span>
                            <span class="token operator">?</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                            <span class="token operator">:</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">,</span>
                    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><strong>å®ç°ä¾‹å­</strong></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mvvm-app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>word<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{word}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sayHi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>change model<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MVVM</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&quot;#mvvm-app&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">word</span><span class="token operator">:</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">sayHi</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> <span class="token string">&quot;Hi, everybody!&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å‚è€ƒæ–‡ç« ï¼š<br>
https://www.freesion.com/article/62001224032/</p> <p>https://www.cnblogs.com/libin-1/p/6893712.html</p> <p>https://github.com/DMQ/mvvm</p> <p>https://segmentfault.com/a/1190000016208088#item-3</p> <p>https://blog.51cto.com/zhoulujun/2350337</p> <h2 id="vue3-x-å“åº”å¼æ•°æ®åŸç†"><a href="#vue3-x-å“åº”å¼æ•°æ®åŸç†" class="header-anchor">#</a> Vue3.x å“åº”å¼æ•°æ®åŸç†</h2> <p>Vue3.x å’Œ Vue2.x æœ¬è´¨ä¸Šå°±æ˜¯åŸºäº <code>Proxy</code> å’ŒåŸºäº <code>Object.defineProperty</code> ä¹‹é—´çš„å·®å¼‚ã€‚</p> <h3 id="vue2-x-çš„å“åº”è§„åˆ™"><a href="#vue2-x-çš„å“åº”è§„åˆ™" class="header-anchor">#</a> Vue2.x çš„å“åº”è§„åˆ™</h3> <p>å¯¹è±¡ï¼š é€’å½’éå†æ¯ä¸ªå±æ€§ï¼Œç»™æ¯ä¸ªå±æ€§å¢åŠ  getter å’Œ setterï¼›æ•°ç»„ï¼š é‡å†™æ•°ç»„çš„æ–¹æ³•ï¼Œè°ƒç”¨æ•°ç»„æ–¹æ³•ä¼šè§¦å‘æ›´æ–°ï¼Œä¹Ÿä¼šç›‘æ§æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹ï¼›ç¼ºç‚¹ï¼š å¯¹è±¡åªèƒ½ç›‘æ§è‡ªå¸¦å±æ€§ï¼Œæ–°å¢å±æ€§ä¸èƒ½ç›‘æ§ï¼ˆé™¤é <code>vue.$set</code>ï¼‰ï¼›æ•°ç»„çš„ç´¢å¼•æ›´æ–°æˆ–é•¿åº¦æ›´æ–°ä¸ä¼šè§¦å‘å®ä½“æ›´æ–°ï¼Œé’ˆå¯¹æ•°ç»„éœ€è¦é‡å†™æ•°ç»„æ–¹æ³•ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">val</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
    <span class="token comment">// target ä¸ºæ•°ç»„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¿®æ”¹æ•°ç»„çš„é•¿åº¦, é¿å…ç´¢å¼•&gt;æ•°ç»„é•¿åº¦å¯¼è‡´splcie()æ‰§è¡Œæœ‰è¯¯</span>
        target<span class="token punctuation">.</span>length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ©ç”¨æ•°ç»„çš„spliceå˜å¼‚æ–¹æ³•è§¦å‘å“åº”å¼</span>
        target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// key å·²ç»å­˜åœ¨ï¼Œç›´æ¥ä¿®æ”¹å±æ€§å€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>

    <span class="token comment">// target æœ¬èº«å°±ä¸æ˜¯å“åº”å¼æ•°æ®, ç›´æ¥èµ‹å€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¯¹å±æ€§è¿›è¡Œå“åº”å¼å¤„ç†</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue3-x-çš„-proxy"><a href="#vue3-x-çš„-proxy" class="header-anchor">#</a> Vue3.x çš„ proxy</h3> <p>Vue3.x ä¸ºä»€ä¹ˆè¦ç”¨ proxy æ›¿ä»£ defineProperty?</p> <p>Proxy åœ¨å¯¹ç›®æ ‡å¯¹è±¡çš„æ“ä½œä¹‹å‰æä¾›äº†æ‹¦æˆªï¼Œå¯ä»¥å¯¹å¤–ç•Œæ“ä½œè¿›è¡Œè¿‡æ»¤æˆ–æ”¹å†™ã€‚é€šè¿‡æ“ä½œå¯¹è±¡çš„ä»£ç†å¯¹è±¡æ¥é—´æ¥æ“ä½œå¯¹è±¡ï¼Œè€Œæ— éœ€ç›´æ¥æ“ä½œå¯¹è±¡æœ¬èº«ã€‚ä¾‹å­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;hhh&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;eat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;drink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;play&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyObj<span class="token punctuation">.</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// get:  {arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;], name: &quot;ccc&quot;}</span>
<span class="token comment">// [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]</span>

proxyObj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;ccc&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// setï¼š {name: &quot;ccc&quot;, arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]}</span>
</code></pre></div><p>Proxy æ”¯æŒçš„æ‹¦æˆªæ“ä½œä¸€å…± 13 ç§ï¼Œæ›´è¯¦ç»†çš„å¯ä»¥æˆ³ <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <p>æ–°çš„å†™æ³•ä¸­ä¼šç”¨ <code>Reflect</code> å¤„ç†ï¼ŒReflect æ˜¯å†…ç½®å¯¹è±¡ï¼Œä¸ºæ“ä½œå¯¹è±¡è€Œæä¾›çš„æ–° APIã€‚<br>
å°† Object å¯¹è±¡çš„å±äºè¯­è¨€å†…éƒ¨çš„æ–¹æ³•æ”¾åˆ° Reflect å¯¹è±¡ä¸Šï¼Œ<strong>å³ä» Reflect å¯¹è±¡ä¸Šæ‹¿ Object å¯¹è±¡å†…å®¹æ–¹æ³•</strong>ã€‚</p> <p>ä¸Šé¢çš„ä¾‹å­æ”¹å†™ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;hhh&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;eat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;drink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;play&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Reflect ä¸æ˜¯å‡½æ•°å¯¹è±¡ï¼Œå› æ­¤ä¸èƒ½å’Œ new è¿ç®—ç¬¦ä¸€èµ·ç”¨ï¼Œç±»ä¼¼äº Math å¯¹è±¡ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢åŒ…å«äº†å¤šä¸ªå’Œ Object å¯¹åº” API</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿™ç§å†™æ³•è®¾ç½®æ—¶å¦‚æœä¸æˆåŠŸä¹Ÿä¸ä¼šæŠ¥é”™ æ¯”å¦‚è¿™ä¸ªå¯¹è±¡é»˜è®¤ä¸å¯é…ç½®</span>
        <span class="token comment">// target[key] = value;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; -&gt; &quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyObj<span class="token punctuation">.</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// get:  {arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;], name: &quot;ccc&quot;}</span>
<span class="token comment">// [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]</span>

proxyObj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;ccc&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// setï¼š {name: &quot;ccc&quot;, arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]}ï¼Œnameï¼Œ{name: &quot;hhh&quot;}  -&gt;  ccc</span>
</code></pre></div> <h3 id="proxy-ä»£ç†å¯¹è±¡æ˜¯æ•°ç»„æ—¶-å¤šæ¬¡è§¦å‘-set-get-å¦‚ä½•ä¼˜åŒ–"><a href="#proxy-ä»£ç†å¯¹è±¡æ˜¯æ•°ç»„æ—¶-å¤šæ¬¡è§¦å‘-set-get-å¦‚ä½•ä¼˜åŒ–" class="header-anchor">#</a> Proxy ä»£ç†å¯¹è±¡æ˜¯æ•°ç»„æ—¶ï¼Œå¤šæ¬¡è§¦å‘ set / getï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</h3> <p>ç”±ä¸Šä¸€ä¸ªé—®é¢˜çš„æœ€åå®ä¾‹ä»£ç å¯çŸ¥ï¼Œå½“ Proxy ä»£ç†ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œä¼šå¼•èµ·å¤šæ¬¡ get æˆ– set çš„é—®é¢˜ã€‚</p> <p>set ä¼šæ‰§è¢«è§¦å‘ä¸¤æ¬¡ï¼Œä¸€æ¬¡èµ‹å€¼æ—¶è§¦å‘ï¼Œå¦å¤–è¿˜ä¼šåœ¨ä¿®æ”¹ length æ—¶è§¦å‘ã€‚å¯¹æ­¤ï¼ŒVue3.0 çš„ä¼˜åŒ–æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;hhh&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;eat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;drink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;play&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">reactive</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// é€’å½’ä»£ç†</span>
                <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> hadKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ–°å¢å±æ€§é¦–æ¬¡è§¦å‘setï¼ŒhadKeyä¸ºfalseï¼Œä¼šè§¦å‘</span>
            <span class="token comment">// ä¿®æ”¹å±æ€§æ—¶ï¼ŒhadKeyä¸ºfalseï¼Œå½“å±æ€§å€¼å’Œæ—§å€¼ä¸ä¸€æ ·æ—¶ä¼šè§¦å‘</span>

            <span class="token comment">// å½“ä»£ç†å¯¹è±¡ä¸ºæ•°ç»„æ—¶ï¼Œä¼ å…¥çš„keyä¸ºlengthæ—¶ï¼Œlengthä¸ºè‡ªèº«å±æ€§å› æ­¤hadKeyä¸ºfalseï¼Œæ¥ç€å› ä¸ºvalueæ˜¯æ•°ç»„å½“å‰çš„lengthï¼ŒoldValueä¹Ÿä¸ºtarget['length']ï¼Œå› æ­¤åˆ¤æ–­oldVal !== valueçš„å€¼ä¹Ÿä¸ºfalseï¼Œæ‰€ä»¥ä¼šè·³è¿‡triggerï¼Œå®ç°é‡å¤è§¦å‘triggerçš„æ•ˆæœ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey <span class="token operator">||</span> oldVal <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;trigger setï¼š&quot;</span><span class="token punctuation">,</span>
                    target<span class="token punctuation">,</span>
                    key<span class="token punctuation">,</span>
                    oldVal<span class="token punctuation">,</span>
                    <span class="token string">&quot; -&gt; &quot;</span><span class="token punctuation">,</span>
                    value
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

proxyObj<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;sleeping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// getï¼š {name: {â€¦}, arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]}  arr  [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]</span>
<span class="token comment">// getï¼š [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]  push   Æ’ push() { [native code] }</span>
<span class="token comment">// getï¼š [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]  length   3</span>
<span class="token comment">// setï¼š [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;, &quot;sleeping&quot;] 3 undefined  -&gt;  sleeping</span>

proxyObj<span class="token punctuation">.</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;play&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// getï¼š {name: {â€¦}, arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]}  arr  [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]</span>
<span class="token comment">// trigger setï¼š[&quot;eat&quot;, &quot;play&quot;, &quot;play&quot;] 1 drink  -&gt;  play</span>
</code></pre></div><h3 id="proxy-æ·±åº¦ä¾¦æµ‹æ•°æ®"><a href="#proxy-æ·±åº¦ä¾¦æµ‹æ•°æ®" class="header-anchor">#</a> Proxy æ·±åº¦ä¾¦æµ‹æ•°æ®</h3> <p>Proxy åªä¼šä»£ç†å¯¹è±¡çš„ç¬¬ä¸€å±‚ï¼ŒVue3 æ˜¯æ€æ ·å¤„ç†è¿™ä¸ªé—®é¢˜ï¼ˆæ·±åº¦ä¾¦æµ‹æ•°æ®ï¼‰çš„å‘¢ï¼Ÿ</p> <p>åˆ¤æ–­å½“å‰ Reflect.get çš„è¿”å›å€¼æ˜¯å¦ä¸º Objectï¼Œå¦‚æœæ˜¯åˆ™å†é€šè¿‡ reactive æ–¹æ³•åšä»£ç†ï¼Œ è¿™æ ·å°±å®ç°äº†æ·±åº¦è§‚æµ‹ã€‚</p> <p>proxy å¯ä»¥ç›´æ¥ç›‘å¬æ•´ä¸ªå¯¹è±¡ã€‚çœå»äº†å¯¹å¯¹è±¡å±æ€§ for in çš„éå†è¿‡ç¨‹ï¼Œæå‡äº†æ•ˆç‡ï¼Œå¹¶ä¸”å¯ä»¥ç›‘å¬æ•°ç»„ï¼Œä¸ç”¨å†å»å•ç‹¬çš„å¯¹æ•°ç»„åšç‰¹å¼‚æ€§æ“ä½œã€‚</p> <p>ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“å¯¹è±¡æ˜¯å¤šå±‚åµŒå¥—çš„å¯¹è±¡æ—¶ï¼Œå¯¹å¤šå±‚çº§çš„å¯¹è±¡æ“ä½œæ—¶ï¼Œset å¹¶ä¸èƒ½æ„ŸçŸ¥åˆ°ï¼Œä½†æ˜¯ get ä¼šè¢«è§¦å‘ï¼Œæ­¤æ—¶å¯åˆ©ç”¨ Reflect.get() è¿”å›çš„â€œå¤šå±‚çº§å¯¹è±¡ä¸­å†…å±‚â€ï¼Œåˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸º Objectï¼Œå¦‚æœæ˜¯åˆ™å†å¯¹â€œå†…å±‚æ•°æ®â€ reactiveï¼ˆé€’å½’è¿›è¡Œ<code>new proxy()</code>ï¼‰æ–¹æ³•åšä»£ç†ï¼Œè¿™æ ·æ‰èƒ½å®ç°æ·±åº¦è§‚æµ‹ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒä»¬ï¼Œæ‰¾åˆ°ä»»ä½•ä»£ç†è¿‡çš„æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠé€šè¿‡ä»£ç†æ•°æ®æ‰¾åˆ°åŸå§‹çš„æ•°æ®ã€‚</span>
<span class="token comment">// å­˜æ”¾åŸå§‹æ•°æ®</span>
<span class="token keyword">const</span> rawToReactive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å­˜æ”¾å“åº”æ•°æ®</span>
<span class="token keyword">const</span> reactiveToRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hadKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// ä»å“åº”æ•°æ®ä¸­è·å–</span>
        value <span class="token operator">=</span> reactiveToRaw<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value<span class="token punctuation">;</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ–°å¢å±æ€§é¦–æ¬¡è§¦å‘setï¼ŒhadKeyä¸ºfalseï¼Œä¼šè§¦å‘</span>
        <span class="token comment">// ä¿®æ”¹å±æ€§æ—¶ï¼ŒhadKeyä¸ºfalseï¼Œå½“å±æ€§å€¼å’Œæ—§å€¼ä¸ä¸€æ ·æ—¶ä¼šè§¦å‘</span>

        <span class="token comment">// å½“ä»£ç†å¯¹è±¡ä¸ºæ•°ç»„æ—¶ï¼Œä¼ å…¥çš„keyä¸ºlengthæ—¶ï¼Œlengthä¸ºè‡ªèº«å±æ€§å› æ­¤hadKeyä¸ºfalseï¼Œæ¥ç€å› ä¸ºvalueæ˜¯æ•°ç»„å½“å‰çš„lengthï¼ŒoldValueä¹Ÿä¸ºtarget['length']ï¼Œå› æ­¤åˆ¤æ–­oldVal !== valueçš„å€¼ä¹Ÿä¸ºfalseï¼Œæ‰€ä»¥ä¼šè·³è¿‡triggerï¼Œå®ç°é‡å¤è§¦å‘triggerçš„æ•ˆæœ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey <span class="token operator">||</span> oldVal <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;trigger setï¼š&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> <span class="token string">&quot; -&gt; &quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">reactive</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> observed <span class="token operator">=</span> rawToReactive<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åŸæ•°æ®å·²ç»æœ‰ç›¸åº”çš„å¯å“åº”æ•°æ®, è¿”å›å¯å“åº”æ•°æ®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>observed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> observed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åŸæ•°æ®å·²ç»æ˜¯å¯å“åº”æ•°æ®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reactiveToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŸæ•°æ®ä¿å­˜å¯¹åº”çš„å¯å“åº”æ•°æ®</span>
    reactiveToRaw<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä¿å­˜å“åº”æ•°æ®</span>
    rawToReactive<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> observed<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// å®ä¾‹</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;hhh&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;eat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;drink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;play&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

proxyObj<span class="token punctuation">.</span>name<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;ccc&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// getï¼š {name: {name: &quot;ccc&quot;}, arr: Array(3)} name {name: &quot;hhh&quot;}</span>
<span class="token comment">// trigger setï¼š {name: &quot;ccc&quot;} name hhh  -&gt;  ccc</span>

proxyObj<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;sleeping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// getï¼š{name: {name: &quot;ccc&quot;}, arr: [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]} arr [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;]</span>
<span class="token comment">// getï¼š[&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;] push Æ’ push() { [native code] }</span>
<span class="token comment">// getï¼š[&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;] length 3</span>
<span class="token comment">// trigger setï¼š (4) [&quot;eat&quot;, &quot;drink&quot;, &quot;play&quot;, &quot;sleeping&quot;] 3 undefined  -&gt;  sleeping</span>
</code></pre></div><p>å‚è€ƒæ–‡ç« ï¼š https://juejin.im/post/5d99be7c6fb9a04e1e7baa34</p> <p>ç”±ä¸Šä»£ç å¯çŸ¥ï¼Œ Vue3 ä¹Ÿå¹¶éç®€å•çš„é€šè¿‡ Proxy æ¥é€’å½’ä¾¦æµ‹æ•°æ®ã€‚æ·±åº¦ä¾¦æµ‹æ•°æ®ä¸»è¦åˆ©ç”¨ get æ“ä½œé€’å½’ä¾¦æµ‹æ¥å®ç°å†…éƒ¨æ•°æ®çš„ä»£ç†ï¼Œå¹¶ä¸”ç»“åˆ WeakMap æ¥å¯¹æ•°æ®ä¿å­˜ï¼Œè¿™å°†å¤§å¤§æé«˜å“åº”å¼æ•°æ®çš„æ€§èƒ½ã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/articles/TypeScript/åŸºç¡€è¯­æ³•ç¯‡.html" class="prev">
        åŸºç¡€è¯­æ³•ç¯‡
      </a></span> <span class="next"><a href="/articles/Vue/diff ç®—æ³•.html">
        ğŸ‘‰ diff ç®—æ³•
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.448d156c.js" defer></script><script src="/assets/js/2.fefa3fa1.js" defer></script><script src="/assets/js/1.67a15f5a.js" defer></script><script src="/assets/js/70.9061bb98.js" defer></script>
  </body>
</html>
