<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>👉 V8 工作原理 | CHIEMINCHAN&#39;S BLOG</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/donut.png">
    <meta name="description" content="Hi, glad you came.">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.448d156c.js" as="script"><link rel="preload" href="/assets/js/2.fefa3fa1.js" as="script"><link rel="preload" href="/assets/js/1.67a15f5a.js" as="script"><link rel="preload" href="/assets/js/43.1d0d8ffd.js" as="script"><link rel="prefetch" href="/assets/js/10.5229b01a.js"><link rel="prefetch" href="/assets/js/11.9dccb5a1.js"><link rel="prefetch" href="/assets/js/12.1aa023e7.js"><link rel="prefetch" href="/assets/js/13.da540175.js"><link rel="prefetch" href="/assets/js/14.981e669d.js"><link rel="prefetch" href="/assets/js/15.f28dd0b3.js"><link rel="prefetch" href="/assets/js/16.47e1d84d.js"><link rel="prefetch" href="/assets/js/17.7ff34030.js"><link rel="prefetch" href="/assets/js/18.6dcbdd16.js"><link rel="prefetch" href="/assets/js/19.e568fd00.js"><link rel="prefetch" href="/assets/js/20.182f1f9b.js"><link rel="prefetch" href="/assets/js/21.b834a74a.js"><link rel="prefetch" href="/assets/js/22.a3523cd2.js"><link rel="prefetch" href="/assets/js/23.61d15c5b.js"><link rel="prefetch" href="/assets/js/24.2aadb209.js"><link rel="prefetch" href="/assets/js/25.836695fb.js"><link rel="prefetch" href="/assets/js/26.0ab922cb.js"><link rel="prefetch" href="/assets/js/27.5ac9e339.js"><link rel="prefetch" href="/assets/js/28.d6a5eb15.js"><link rel="prefetch" href="/assets/js/29.3eea682e.js"><link rel="prefetch" href="/assets/js/3.fc739620.js"><link rel="prefetch" href="/assets/js/30.5225944d.js"><link rel="prefetch" href="/assets/js/31.ec02d3da.js"><link rel="prefetch" href="/assets/js/32.bd05dede.js"><link rel="prefetch" href="/assets/js/33.4a293dcf.js"><link rel="prefetch" href="/assets/js/34.4464026b.js"><link rel="prefetch" href="/assets/js/35.4dd4f327.js"><link rel="prefetch" href="/assets/js/36.ca28dda7.js"><link rel="prefetch" href="/assets/js/37.3a17971f.js"><link rel="prefetch" href="/assets/js/38.f86fa51b.js"><link rel="prefetch" href="/assets/js/39.6ff149b0.js"><link rel="prefetch" href="/assets/js/4.0471e9ae.js"><link rel="prefetch" href="/assets/js/40.23565895.js"><link rel="prefetch" href="/assets/js/41.0116a1ec.js"><link rel="prefetch" href="/assets/js/42.c38f3e0c.js"><link rel="prefetch" href="/assets/js/44.631fa43e.js"><link rel="prefetch" href="/assets/js/45.0f88df1f.js"><link rel="prefetch" href="/assets/js/46.cc671ab0.js"><link rel="prefetch" href="/assets/js/47.90cce12d.js"><link rel="prefetch" href="/assets/js/48.ad0ce6a4.js"><link rel="prefetch" href="/assets/js/49.ade35f37.js"><link rel="prefetch" href="/assets/js/5.5356be46.js"><link rel="prefetch" href="/assets/js/50.de00c31b.js"><link rel="prefetch" href="/assets/js/51.9de8257a.js"><link rel="prefetch" href="/assets/js/52.50f1abf2.js"><link rel="prefetch" href="/assets/js/53.b3b3acb2.js"><link rel="prefetch" href="/assets/js/54.71bfe1b2.js"><link rel="prefetch" href="/assets/js/55.b00cfb1c.js"><link rel="prefetch" href="/assets/js/56.1bb058d3.js"><link rel="prefetch" href="/assets/js/57.5651fd65.js"><link rel="prefetch" href="/assets/js/58.3dd11306.js"><link rel="prefetch" href="/assets/js/59.233d45e8.js"><link rel="prefetch" href="/assets/js/6.5b3d5499.js"><link rel="prefetch" href="/assets/js/60.7c729149.js"><link rel="prefetch" href="/assets/js/61.eb5805f6.js"><link rel="prefetch" href="/assets/js/62.fde12179.js"><link rel="prefetch" href="/assets/js/63.3358d1e0.js"><link rel="prefetch" href="/assets/js/64.1b930210.js"><link rel="prefetch" href="/assets/js/65.3048ba53.js"><link rel="prefetch" href="/assets/js/66.a065502e.js"><link rel="prefetch" href="/assets/js/67.715eef17.js"><link rel="prefetch" href="/assets/js/68.edf44196.js"><link rel="prefetch" href="/assets/js/69.94cb6d60.js"><link rel="prefetch" href="/assets/js/7.c94df317.js"><link rel="prefetch" href="/assets/js/70.9061bb98.js"><link rel="prefetch" href="/assets/js/71.980c8e32.js"><link rel="prefetch" href="/assets/js/72.43be58ba.js"><link rel="prefetch" href="/assets/js/73.e2f40377.js"><link rel="prefetch" href="/assets/js/74.9ef8a48c.js"><link rel="prefetch" href="/assets/js/75.b006fb40.js"><link rel="prefetch" href="/assets/js/76.311cf38f.js"><link rel="prefetch" href="/assets/js/77.2d4b2c6d.js"><link rel="prefetch" href="/assets/js/78.81fd1ead.js"><link rel="prefetch" href="/assets/js/79.01e24fba.js"><link rel="prefetch" href="/assets/js/80.b15cc1f3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.934ed2fb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">CHIEMINCHAN'S BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  知识碎片
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读/观后感
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  知识碎片
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读/观后感
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DesignPatterns</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/JavaScript/JavaScript执行上下文.html" class="sidebar-link">👉 JavaScript 执行上下文</a></li><li><a href="/articles/JavaScript/PromiseA+实现原理.html" class="sidebar-link">👉 Promise/A+ 实现原理</a></li><li><a href="/articles/JavaScript/V8工作原理.html" class="active sidebar-link">👉 V8 工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#javascript-内存空间" class="sidebar-link">JavaScript 内存空间</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#栈空间和堆空间" class="sidebar-link">栈空间和堆空间</a></li><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#闭包的内存模型" class="sidebar-link">闭包的内存模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#垃圾数据如何自动回收" class="sidebar-link">垃圾数据如何自动回收</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#调用栈的垃圾回收" class="sidebar-link">调用栈的垃圾回收</a></li><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#堆空间的垃圾回收" class="sidebar-link">堆空间的垃圾回收</a></li><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#主垃圾回收器和副垃圾回收器" class="sidebar-link">主垃圾回收器和副垃圾回收器</a></li><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#全停顿" class="sidebar-link">全停顿</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#v8-执行代码流程" class="sidebar-link">V8 执行代码流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/JavaScript/V8工作原理.html#编译器和解析器" class="sidebar-link">编译器和解析器</a></li></ul></li></ul></li><li><a href="/articles/JavaScript/call、apply、bind的实现.html" class="sidebar-link">👉 call、apply、bind 的实现</a></li><li><a href="/articles/JavaScript/事件流和事件处理程序.html" class="sidebar-link">👉 事件流和事件处理程序</a></li><li><a href="/articles/JavaScript/关于Promise的一些事.html" class="sidebar-link">👉 关于 Promise 的一些事</a></li><li><a href="/articles/JavaScript/浏览器的 JavaScript 事件循环机制.html" class="sidebar-link">👉 浏览器的 JavaScript 事件循环机制</a></li><li><a href="/articles/JavaScript/深浅拷贝的实现.html" class="sidebar-link">👉 深浅拷贝的实现</a></li><li><a href="/articles/JavaScript/理解 JavaScript 的 async 和 await.html" class="sidebar-link">👉 理解 JavaScript 的 async/await</a></li><li><a href="/articles/JavaScript/继承.html" class="sidebar-link">👉 继承</a></li><li><a href="/articles/JavaScript/防抖和节流.html" class="sidebar-link">👉 防抖和节流</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Microapp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Project Management</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="v8-工作原理"><a href="#v8-工作原理" class="header-anchor">#</a> 👉 V8 工作原理</h1> <h2 id="javascript-内存空间"><a href="#javascript-内存空间" class="header-anchor">#</a> JavaScript 内存空间</h2> <p>JavaScript 是一门在运行过程中需要检查数据类型，并支持隐式类型转换的语言，即为一门弱类型的动态语言：</p> <p>1）弱类型，意味支持隐式类型转换，你不需要告诉 JavaScript 引擎这个或那个变量是什么数据类型，JavaScript 引擎在运行代码的时候自己会计算出来。</p> <p>2）动态，意味着你可以使用同一个变量保存不同类型的数据。</p> <p>在 JavaScript 的执行过程中，主要有三种类型内存空间，分别是代码空间、栈空间和堆空间。其中的代码空间主要是存储可执行代码的，栈空间主要拥有管理存储执行上下文，堆空间则是存储引用数据类型。</p> <h3 id="栈空间和堆空间"><a href="#栈空间和堆空间" class="header-anchor">#</a> 栈空间和堆空间</h3> <h4 id="栈空间-call-stack"><a href="#栈空间-call-stack" class="header-anchor">#</a> 栈空间（Call Stack）</h4> <p>栈空间就是调用栈，一种用来管理执行上下文的数据结构，符合后进先出的规则。(可以理解为是 《<a href="https://chieminchan.vercel.app/articles/JavaScript/JavaScript%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87.html" target="_blank" rel="noopener noreferrer">JavaScript 执行上下文<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 》中的执行上下文栈。)</p> <p>每调用一个函数，JavaScript 引擎会为其创建执行上下文，并把该执行上下文压入调用栈，然后 JavaScript 引擎开始执行函数代码。</p> <p>如果在一个函数 A 中调用了另外一个函数 B，那么 JavaScript 引擎会为 B 函数创建执行上下文，并将 B 函数的执行上下文压入栈顶。当前函数执行完毕后，JavaScript 引擎会将该函数的执行上下文弹出栈。</p> <p>不过有一点要注意，调用栈是有大小的，当入栈的执行上下文超过一定数目，JavaScript 引擎就会报错，我们把这种错误叫做栈溢出。（错位信息：超过了最大栈调用大小，<code>Uncaught RangeError: Maximum call stack size exceeded</code>）。</p> <p>让我们来看一个栈空间存储数据的栗子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;极客时间&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> d <span class="token operator">=</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li><p>这段代码执行时，首先会创建一个全局执行上下文，被压入栈中；</p></li> <li><p>对全局执行上下文中的出现的变量，初始化到变量环境中，初始化值为 undefined；</p></li> <li><p>执行阶段，变量 a 和变量 b 都被赋值为<code>极客时间</code>；此时变量 a 和变量 b 的值都被保存在执行上下文中，而执行上下文又被压入到栈中，所以可以认为变量 a 和变量 b 的值都是存放在栈中的。</p></li> <li><p>执行第 4 行代码，由于 JavaScript 引擎判断右边的值是一个引用类型，这时候处理的情况就不一样了：JavaScript 引擎并不是直接将该对象存放到变量环境中，而是将它分配到堆空间里面，分配后该对象会有一个在“堆”中的地址，然后再将该数据的地址写进 c 的变量值，分配好内存的示意图如下所示：</p></li></ol> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/stash1.png" alt="VM8-内存空间" title="VM8-内存空间"></p> <ol start="5"><li>执行第 5 行代码，将 c 赋值给 d，其实就是把 c 的引用地址赋值给 d，即 c 和 d 的值都是指向同一个在堆中的对象，所以如果通过 c 修改 name 的值，变量 d 的值也跟着改变。</li></ol> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/stash2.png" alt="VM8-内存空间" title="VM8-内存空间"></p> <h4 id="堆空间-memory-heap"><a href="#堆空间-memory-heap" class="header-anchor">#</a> 堆空间（Memory Heap）</h4> <p>由上述例子可知，引用类型是存放在堆空间的，在栈空间中只是保留了对象的引用地址，当 JavaScript 需要访问该数据的时候，是通过栈中的引用地址来访问的，相当于多了一道转手流程。</p> <p>栈空间都不会设置太大，主要用来存放一些原始类型的小数据。</p> <p>而引用类型的数据占用的空间都比较大，所以这一类数据会被存放到堆中，堆空间很大，能存放很多大的数据，不过缺点是分配内存和回收内存都会占用一定的时间。</p> <h3 id="闭包的内存模型"><a href="#闭包的内存模型" class="header-anchor">#</a> 闭包的内存模型</h3> <p>在原始类型数据会被存储到栈空间，引用类型会被存到堆空间的基础上，再回来看一下闭包的例子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot; 极客时间 &quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> test1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> test2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> innerBar <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">setName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            myName <span class="token operator">=</span> newName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> myName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> innerBar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bar<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot; 极客邦 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bar<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当一个外部函数包含一个内部函数，JavaScript 引擎会对内部函数做一次快速的词法扫描，如果发现内部函数引用了外部函数的变量，JavaScript 引擎会判断这是一个闭包，于是在堆空间创建换一个“closure(foo)”的对象（这是一个内部对象，JavaScript 是无法访问的），用来保存 myName 变量。</p> <p>接着继续扫描到 getName 方法时，发现该函数内部还引用变量 test1，于是 JavaScript 引擎又将 test1 添加到“closure(foo)”对象中。这时候堆中的“closure(foo)”对象中就包含了 myName 和 test1 两个变量了。</p> <p>当产生了闭包时的核心有两步：<br>
第一步是需要预扫描内部函数；<br>
第二步是把内部函数引用的外部变量保存到堆中。</p> <h2 id="垃圾数据如何自动回收"><a href="#垃圾数据如何自动回收" class="header-anchor">#</a> 垃圾数据如何自动回收</h2> <h3 id="调用栈的垃圾回收"><a href="#调用栈的垃圾回收" class="header-anchor">#</a> 调用栈的垃圾回收</h3> <p>调用栈中，会有一个记录当前执行状态的指针（称为 ESP 指针） 指向当前正在执行的执行上下文。当执行时完毕，JS 会将 ESP 向下移动，指向另一个上下文。</p> <p>这个下移操作就是销毁调用栈中执行上下文的过程。</p> <h3 id="堆空间的垃圾回收"><a href="#堆空间的垃圾回收" class="header-anchor">#</a> 堆空间的垃圾回收</h3> <p>在上下文销毁后，堆内存依然会被占用，V8 引擎对堆的数据采取垃圾回收器机制。</p> <p>依据代际假说的两个准则：<br>
1）大部分对象在内存中存活时间短<br>
2）不死的对象会活得更久</p> <p>V8 会把堆分成新生区和老生区：<br>
对于新生区，用于存放大多数小的对象。支持 1-8M 容器，因为内存空间不算大，回收次数较为频繁。<br>
对于老生区，用于存放大的对象和新生代晋升的对象。占用空间大，存活时间长。</p> <p>对于这两块区域，V8 分别使用两个不同的垃圾回收器，以便更高效地实施垃圾回收：<br>
副垃圾回收器，主要负责新生代的垃圾回收。<br>
主垃圾回收器，主要负责老生代的垃圾回收。</p> <h3 id="主垃圾回收器和副垃圾回收器"><a href="#主垃圾回收器和副垃圾回收器" class="header-anchor">#</a> 主垃圾回收器和副垃圾回收器</h3> <p>两类垃圾回收器在回收操作方式上有一定差异，但大体上都有一套共同的执行流程：</p> <ol><li>标记：标记空间中的活动对象和非活动对象，把非活动对象标记为可回收对象；</li> <li>清除：清理回收非活动对象所占据的内存空间；</li> <li>整理：非活动对象所占据的内存空间被回收后会产生不连续的内存碎片，为了后续分配较大连续内存，需对这些内存碎片进行整理。</li></ol> <h4 id="新生代区域-副垃圾回收器"><a href="#新生代区域-副垃圾回收器" class="header-anchor">#</a> 新生代区域 - 副垃圾回收器</h4> <p>新生代区域中采用 Scavenge 算法来处理，即把新生代空间对半划分为两个区域，一半是对象区域，一半是空闲区域。</p> <p>其流程是：</p> <ol><li>新加入的对象就被放至对象区，对象区快满的时候会触发一轮垃圾回收；</li> <li>垃圾回收过程中，首先会对对象区的垃圾对象进行标记；</li> <li>标记阶段完成后，进入清理阶段，副垃圾回收器会清理可回收对象，并将存活对象<strong>有序地连续复制</strong>至空闲区（相当于完成了内存碎片整理那一步）；</li> <li>复制完毕后，将对象区和空闲区进行角色翻转。这样就完成了新生代区的垃圾对象回收操作。</li></ol> <p>为了保证新生代区的复制操作的执行效率，新生代区域的空间不会设置太大，避免执行效率低耗时长。</p> <p>因为新生代的空间不大，容易被需长久存活的对象存满，为了解决这个问题，V8 引擎采用了晋升策略。对新生代区域中经过两轮垃圾回收后依然存活的对象，会晋升被放至老生代区域中。</p> <h4 id="老生代区域-主垃圾回收器"><a href="#老生代区域-主垃圾回收器" class="header-anchor">#</a> 老生代区域 - 主垃圾回收器</h4> <p>老生代区域主要存放大对象和新生代晋升对象，有着占用空间大、存活时间长的特点，所以不适用 Scavenge 算法，否则浪费空间且执行效率低。</p> <p>老生代区域主要采用<strong>标记-清除</strong>算法（Mark-Sweep），其流程是：</p> <ol><li>首先是标记阶段，会从根元素开始，遍历调用栈执行上下文，能达到的对象会被标记为活动对象，否则会被标记可回收数据。</li> <li>进入清除阶段，会对可回收数据直接进行清理，因此会产出不连续的内存碎片。</li> <li>进入整理阶段，采用**标记 - 整理(Mark-Compact)**方法（类似标记-清除法），只是不对可回收对象进行清理，而是让所有存活的对象都向一端移动，直接清理掉端边界以外的内存。</li></ol> <h3 id="全停顿"><a href="#全停顿" class="header-anchor">#</a> 全停顿</h3> <p>一旦执行垃圾回收算法，都需要将正在执行的 JavaScript 脚本暂停下来，待垃圾回收完毕后再恢复脚本执行。这种行为叫做全停顿（Stop-The-World）。</p> <p>对于新生代区，因其空间较小，且存活对象较少，全停顿影响不大。</p> <p>对于老生代区，堆空间对象较大，整个全停顿过程会导致页面卡顿。</p> <p>为了降低老生代的垃圾回收而造成的卡顿，V8 采用<strong>增量标记法</strong>（Incremental Marking）算法，将标记过程分为一个个的子标记过程，同时让垃圾回收标记和 JavaScript 应用逻辑交替进行，直到标记阶段完成。</p> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/stop.png" alt="stop" title="stop"></p> <h2 id="v8-执行代码流程"><a href="#v8-执行代码流程" class="header-anchor">#</a> V8 执行代码流程</h2> <h3 id="编译器和解析器"><a href="#编译器和解析器" class="header-anchor">#</a> 编译器和解析器</h3> <blockquote><p>之所以存在编译器和解释器，是因为机器不能直接理解我们所写的代码，所以在执行程序之前，需要将我们所写的代码“翻译”成机器能读懂的机器语言。按语言的执行流程，可以把语言划分为编译型语言和解释型语言。</p></blockquote> <p>对于编译型语言和解释型语言，都需要将源代码通过<strong>词法解析和语法解析生成抽象语法树（ AST）</strong>，然后再分别对这个 AST 继续进行不同方式的解析。</p> <h4 id="编译器处理-ast"><a href="#编译器处理-ast" class="header-anchor">#</a> 编译器处理 AST</h4> <p>对于编译型语言，有了 AST 之后，计算机可以能理解高级语言代码了，但是需要编译器产生低级语言，比如汇编代码才能被机器执行。直接从 AST 开始距离比较远。</p> <p>因为 AST 是嵌套的、树形的；汇编代码是线性的、顺序的。所以需要先转成一种线性的代码，再生成低级代码。这里暂时不详细展开具体流程，大概的流程就是：</p> <ol><li>对 AST 树进行语法分析（代码语法正确性检查）、作用域分析（分析函数块）...；</li> <li>对语法分析后的 AST 翻译和优化成线性代码（中间代码）；</li> <li>将线性代码生成汇编代码；</li> <li>通过汇编器生成处理器能识别的机器码；</li> <li>如果编译成功，将会生成一个可执行的文件（二进制文件）。但如果编译过程发生了语法或者其他的错误，那么编译器就会抛出异常，最后的二进制文件也不会生成成功。</li></ol> <h4 id="解释器处理流程"><a href="#解释器处理流程" class="header-anchor">#</a> 解释器处理流程</h4> <p>JavaScript 属于解释型语言，因此不需要生成线性代码和进行汇编过程，只需要在每次运行时通过解释器对程序进行动态解释和执行。它的流程主要有：</p> <h5 id="_1-生成-ast-和执行上下文"><a href="#_1-生成-ast-和执行上下文" class="header-anchor">#</a> 1. 生成 AST 和执行上下文</h5> <p>源代码通过词法解析和语法解析生成抽象语法树 AST，同时创建执行上下文。</p> <ul><li>分词/词法解析（tokenize）</li></ul> <p>词法描述的是最小的单词格式，词法解析就是对源代码进行分词，将字符串拆分成一个个最小的不可再拆的单词，又叫 token，比如 if、else、break...，每个 token 识别完就可以抛出来，最终产出一个 token 数组。</p> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/tokenize.png" alt="tokenize" title="tokenize"></p> <ul><li>解析/语法解析（parse）</li></ul> <p>语法解析就是将上一步的 token 数组按照语法规则进行组装，组装成 AST 树。</p> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/ast.png" alt="ast" title="ast"></p> <p>有了 AST 以后， V8 就会生成该段代码的执行上下文。</p> <h5 id="_2-生成字节码"><a href="#_2-生成字节码" class="header-anchor">#</a> 2. 生成字节码</h5> <p>有了抽象语法树 AST 和执行上下文，通过<strong>解析器 Ignition</strong>根据 AST 生成字节码；（之前没有字节码一说，而是直接将 AST 转成机器码，机器码执行效率高但占用内存大。）</p> <p>字节码就是介于 AST 和机器码中间的一种代码，高级代码、字节码和机器码的关系如下图：</p> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/bytecode.png" alt="bytecode" title="bytecode"></p> <blockquote><p>从图中可以看出，机器码所占用的空间远远超过了字节码，所以使用字节码可以减少系统的内存使用。</p></blockquote> <h5 id="_3-执行字节码-机器码"><a href="#_3-执行字节码-机器码" class="header-anchor">#</a> 3. 执行字节码（&amp;机器码）</h5> <p>在生成了字节码以后，进入执行阶段，解析器会对字节码逐条解析执行。</p> <p>如果在执行中，发现该段字节码被重复执行（也称为热点代码），这时候后台<strong>编译器 turbofan</strong>登场，会将该热点代码编译成为高效的机器码。当再次执行到该段热点代码时，只需要直接执行编译后的机器码就可以了，这样就大大提升了代码的执行效率。</p> <p><img src="https://raw.githubusercontent.com/chieminchan/chieminchan.github.io/master/images/articles/v8/JIT.png" alt="JIT" title="JIT"></p> <blockquote><p>其实字节码配合解释器和编译器是最近一段时间很火的技术，比如 Java 和 Python 的虚拟机也都是基于这种技术实现的，我们把这种技术称为即时编译（JIT）。具体到 V8，就是指解释器 Ignition 在解释执行字节码的同时，收集代码信息，当它发现某一部分代码变热了之后，TurboFan 编译器便闪亮登场，把热点的字节码转换为机器码，并把转换后的机器码保存起来，以备下次使用。</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/JavaScript/PromiseA+实现原理.html" class="prev">
        👉 Promise/A+ 实现原理
      </a></span> <span class="next"><a href="/articles/JavaScript/call、apply、bind的实现.html">
        👉 call、apply、bind 的实现
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.448d156c.js" defer></script><script src="/assets/js/2.fefa3fa1.js" defer></script><script src="/assets/js/1.67a15f5a.js" defer></script><script src="/assets/js/43.1d0d8ffd.js" defer></script>
  </body>
</html>
