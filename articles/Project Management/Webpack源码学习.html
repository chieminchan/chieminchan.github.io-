<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>👉 webpack 构建流程 | CHIEMINCHAN&#39;S BLOG</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/donut.png">
    <meta name="description" content="Hi, glad you came.">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.448d156c.js" as="script"><link rel="preload" href="/assets/js/2.fefa3fa1.js" as="script"><link rel="preload" href="/assets/js/1.67a15f5a.js" as="script"><link rel="preload" href="/assets/js/63.3358d1e0.js" as="script"><link rel="prefetch" href="/assets/js/10.5229b01a.js"><link rel="prefetch" href="/assets/js/11.9dccb5a1.js"><link rel="prefetch" href="/assets/js/12.1aa023e7.js"><link rel="prefetch" href="/assets/js/13.da540175.js"><link rel="prefetch" href="/assets/js/14.981e669d.js"><link rel="prefetch" href="/assets/js/15.f28dd0b3.js"><link rel="prefetch" href="/assets/js/16.47e1d84d.js"><link rel="prefetch" href="/assets/js/17.7ff34030.js"><link rel="prefetch" href="/assets/js/18.6dcbdd16.js"><link rel="prefetch" href="/assets/js/19.e568fd00.js"><link rel="prefetch" href="/assets/js/20.182f1f9b.js"><link rel="prefetch" href="/assets/js/21.b834a74a.js"><link rel="prefetch" href="/assets/js/22.a3523cd2.js"><link rel="prefetch" href="/assets/js/23.61d15c5b.js"><link rel="prefetch" href="/assets/js/24.2aadb209.js"><link rel="prefetch" href="/assets/js/25.836695fb.js"><link rel="prefetch" href="/assets/js/26.0ab922cb.js"><link rel="prefetch" href="/assets/js/27.5ac9e339.js"><link rel="prefetch" href="/assets/js/28.d6a5eb15.js"><link rel="prefetch" href="/assets/js/29.3eea682e.js"><link rel="prefetch" href="/assets/js/3.fc739620.js"><link rel="prefetch" href="/assets/js/30.5225944d.js"><link rel="prefetch" href="/assets/js/31.ec02d3da.js"><link rel="prefetch" href="/assets/js/32.bd05dede.js"><link rel="prefetch" href="/assets/js/33.4a293dcf.js"><link rel="prefetch" href="/assets/js/34.4464026b.js"><link rel="prefetch" href="/assets/js/35.4dd4f327.js"><link rel="prefetch" href="/assets/js/36.ca28dda7.js"><link rel="prefetch" href="/assets/js/37.3a17971f.js"><link rel="prefetch" href="/assets/js/38.f86fa51b.js"><link rel="prefetch" href="/assets/js/39.6ff149b0.js"><link rel="prefetch" href="/assets/js/4.0471e9ae.js"><link rel="prefetch" href="/assets/js/40.23565895.js"><link rel="prefetch" href="/assets/js/41.0116a1ec.js"><link rel="prefetch" href="/assets/js/42.c38f3e0c.js"><link rel="prefetch" href="/assets/js/43.1d0d8ffd.js"><link rel="prefetch" href="/assets/js/44.631fa43e.js"><link rel="prefetch" href="/assets/js/45.0f88df1f.js"><link rel="prefetch" href="/assets/js/46.cc671ab0.js"><link rel="prefetch" href="/assets/js/47.90cce12d.js"><link rel="prefetch" href="/assets/js/48.ad0ce6a4.js"><link rel="prefetch" href="/assets/js/49.ade35f37.js"><link rel="prefetch" href="/assets/js/5.5356be46.js"><link rel="prefetch" href="/assets/js/50.de00c31b.js"><link rel="prefetch" href="/assets/js/51.9de8257a.js"><link rel="prefetch" href="/assets/js/52.50f1abf2.js"><link rel="prefetch" href="/assets/js/53.b3b3acb2.js"><link rel="prefetch" href="/assets/js/54.71bfe1b2.js"><link rel="prefetch" href="/assets/js/55.b00cfb1c.js"><link rel="prefetch" href="/assets/js/56.1bb058d3.js"><link rel="prefetch" href="/assets/js/57.5651fd65.js"><link rel="prefetch" href="/assets/js/58.3dd11306.js"><link rel="prefetch" href="/assets/js/59.233d45e8.js"><link rel="prefetch" href="/assets/js/6.5b3d5499.js"><link rel="prefetch" href="/assets/js/60.7c729149.js"><link rel="prefetch" href="/assets/js/61.eb5805f6.js"><link rel="prefetch" href="/assets/js/62.fde12179.js"><link rel="prefetch" href="/assets/js/64.1b930210.js"><link rel="prefetch" href="/assets/js/65.3048ba53.js"><link rel="prefetch" href="/assets/js/66.a065502e.js"><link rel="prefetch" href="/assets/js/67.715eef17.js"><link rel="prefetch" href="/assets/js/68.edf44196.js"><link rel="prefetch" href="/assets/js/69.94cb6d60.js"><link rel="prefetch" href="/assets/js/7.c94df317.js"><link rel="prefetch" href="/assets/js/70.9061bb98.js"><link rel="prefetch" href="/assets/js/71.980c8e32.js"><link rel="prefetch" href="/assets/js/72.43be58ba.js"><link rel="prefetch" href="/assets/js/73.e2f40377.js"><link rel="prefetch" href="/assets/js/74.9ef8a48c.js"><link rel="prefetch" href="/assets/js/75.b006fb40.js"><link rel="prefetch" href="/assets/js/76.311cf38f.js"><link rel="prefetch" href="/assets/js/77.2d4b2c6d.js"><link rel="prefetch" href="/assets/js/78.81fd1ead.js"><link rel="prefetch" href="/assets/js/79.01e24fba.js"><link rel="prefetch" href="/assets/js/80.b15cc1f3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.934ed2fb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">CHIEMINCHAN'S BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  知识碎片
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读/观后感
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  知识碎片
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读/观后感
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DesignPatterns</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Microapp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Project Management</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/Project Management/Webapck热替换.html" class="sidebar-link">👉 Webpack 热替换</a></li><li><a href="/articles/Project Management/Webpack 基础扫盲.html" class="sidebar-link">👉 Webpack 基础扫盲</a></li><li><a href="/articles/Project Management/Webpack源码学习.html" class="active sidebar-link">👉 webpack 构建流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Project Management/Webpack源码学习.html#webpack-做了什么" class="sidebar-link">webpack 做了什么</a></li><li class="sidebar-sub-header"><a href="/articles/Project Management/Webpack源码学习.html#webpack-的构建流程" class="sidebar-link">webpack 的构建流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Project Management/Webpack源码学习.html#初始化阶段-compile" class="sidebar-link">初始化阶段（compile）</a></li><li class="sidebar-sub-header"><a href="/articles/Project Management/Webpack源码学习.html#构建阶段-make" class="sidebar-link">构建阶段（make）</a></li><li class="sidebar-sub-header"><a href="/articles/Project Management/Webpack源码学习.html#生成阶段-seal" class="sidebar-link">生成阶段（seal）</a></li><li class="sidebar-sub-header"><a href="/articles/Project Management/Webpack源码学习.html#写入阶段-emit" class="sidebar-link">写入阶段（emit）</a></li></ul></li></ul></li><li><a href="/articles/Project Management/Web性能优化.html" class="sidebar-link">👉 Web 性能优化</a></li><li><a href="/articles/Project Management/npm 包管理.html" class="sidebar-link">👉 npm 包管理</a></li><li><a href="/articles/Project Management/rollup 入门篇.html" class="sidebar-link">👉 rollup 入门篇</a></li><li><a href="/articles/Project Management/手把手教你发个npm包.html" class="sidebar-link">👉 手把手教你发个 npm 包</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-构建流程"><a href="#webpack-构建流程" class="header-anchor">#</a> 👉 webpack 构建流程</h1> <p>参考文章：</p> <ul><li><a href="https://mp.weixin.qq.com/s/ZJBwPp64TKMl230SKxHluA" target="_blank" rel="noopener noreferrer">90 行代码的 webpack，你确定不学吗？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mp.weixin.qq.com/s?__biz=MzI0MTUxOTE5NQ==&amp;mid=2247484030&amp;idx=1&amp;sn=d630d4b3995bbfd50f99e781074acfeb" target="_blank" rel="noopener noreferrer">一文掌握 Webpack 编译流程 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/frontend_frank/article/details/106205260" target="_blank" rel="noopener noreferrer">揭秘 webpack 插件工作流程和原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6844903895584473096" target="_blank" rel="noopener noreferrer">Webpack 源码解读：理清编译主流程 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/73325163" target="_blank" rel="noopener noreferrer">webpack 是如何实现动态导入的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6844904180285456398" target="_blank" rel="noopener noreferrer">『Webpack 系列』—— 路由懒加载的原理 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>还有，tecvan 大佬总结的非常有深度的 webpack 系列：</p> <ul><li><a href="https://juejin.cn/post/6949040393165996040" target="_blank" rel="noopener noreferrer">[万字总结] 一文吃透 Webpack 核心原理 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6958811421224206343" target="_blank" rel="noopener noreferrer">有点难的 webpack 知识点：Dependency Graph 深度解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="webpack-做了什么"><a href="#webpack-做了什么" class="header-anchor">#</a> webpack 做了什么</h2> <p>我们可以从构建文件作为开始，进行分析。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> one <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./one.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// one.js</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./two.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> two <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;import two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// two.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;html-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CleanWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;clean-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">main</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&quot;js/[chunkhash].js&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;webpack-case&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../public/index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>最后执行<code>webpack --config webpack.config.js</code>后，在<code>dist/js</code>文件夹下创建了一个<code>35f63560f4987ba7b874.js（对应主入口）和35f63560f4987ba7b874.js（一个对应动态引入的two.js）</code></p> <p>在删除了一些注视符号和增加了一些帮助自己理解的注释后：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// e74980cea533ebbd6176.js</span>

<span class="token comment">// self[&quot;webpackChunkwebpack_cases&quot;]数组会push进一个数组，而这个数组是two.js的信息，其中第二项是正是表示源码的一个对象</span>
<span class="token punctuation">(</span>self<span class="token punctuation">[</span><span class="token string">&quot;webpackChunkwebpack_cases&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    self<span class="token punctuation">[</span><span class="token string">&quot;webpackChunkwebpack_cases&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;src_two_js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;./src/two.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">eval</span><span class="token punctuation">(</span>
                <span class="token string">&quot;// two.js\nmodule.exports = function () {\n  console.log('two')\n}\n\n//# sourceURL=webpack://webpack-cases/./src/two.js?&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 35f63560f4987ba7b874.js</span>

<span class="token comment">// 创建一个自执行函数</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// webpackBootstrap</span>

    <span class="token comment">// index.js和one.js 被以键值对的形式保存到了 __webpack_modules__ 上</span>
    <span class="token comment">// 对象的 key 为模块路径名，value 为一个被包装过的模块函数。</span>
    <span class="token comment">// 函数拥有 module, module.exports, __webpack_require__ 三个参数。</span>
    <span class="token comment">// 这使得每个模块都拥有使用 module.exports 导出本模块和使用 __webpack_require__ 引入其他模块的能力，同时保证了每个模块都处于一个隔离的函数作用域范围。</span>
    <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span>
            <span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span>
            __unused_webpack_exports<span class="token punctuation">,</span>
            __webpack_require__</span>
        <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">eval</span><span class="token punctuation">(</span>
                <span class="token string">&quot;const one = __webpack_require__(/*! ./one.js */ \&quot;./src/one.js\&quot;);\none();\n\n// class Animal {\n//   constructor(name) {\n//       this.name = name;\n//   }\n//   getName() {\n//       return this.name;\n//   }\n// }\n\n// const dog = new Animal('dog');\n\n//# sourceURL=webpack://webpack-cases/./src/index.js?&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token string-property property">&quot;./src/one.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span>
            <span class="token parameter">module<span class="token punctuation">,</span>
            __unused_webpack_exports<span class="token punctuation">,</span>
            __webpack_require__</span>
        <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对于异步引入会被转换成 __webpack_require__.e</span>
            <span class="token comment">// __webpack_require__.e方法是实现懒加载的核心</span>
            <span class="token function">eval</span><span class="token punctuation">(</span>
                <span class="token string">&quot;__webpack_require__.e(/*! import() */ \&quot;src_two_js\&quot;).then(__webpack_require__.t.bind(__webpack_require__, /*! ./two.js */ \&quot;./src/two.js\&quot;, 23)).then(({two}) =&gt; {\n  console.log('import two');\n  two();\n})\n\nmodule.exports = function () {\n  console.log('one')\n}\n\n//# sourceURL=webpack://webpack-cases/./src/one.js?&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// The module cache</span>
    <span class="token comment">// 使用 __webpack_require__ 函数加载完成的模块会被缓存到 __webpack_module_cache__ 对象上，以便下次如果有其他模块依赖此模块时，不需要重新运行模块的包装函数，减少执行效率的消耗。同时，也避免了循环依赖无限递归的出现。</span>
    <span class="token keyword">var</span> __webpack_module_cache__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义require函数</span>
    <span class="token comment">// require是node环境自带的环境变量，可以直接使用，而在其他环境则没有这样一个变量，于是需要webpack提供这样相似的能力，</span>
    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查是否已经构建过</span>
        <span class="token comment">// Check if module is in cache</span>
        <span class="token keyword">var</span> cachedModule <span class="token operator">=</span> __webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 新构建，则为它创建一个专属的moduleId并缓存起来</span>
        <span class="token comment">// Create a new module (and put it into the cache)</span>
        <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>__webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">// no module.id needed</span>
            <span class="token comment">// no module.loaded needed</span>
            <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行模块里的函数代码</span>
        <span class="token comment">// Execute the module function</span>
        __webpack_modules__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span>
            module<span class="token punctuation">,</span>
            module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
            __webpack_require__
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Return the exports of the module</span>
        <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 暴露modules expose the modules object (__webpack_modules__)</span>
    __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> __webpack_modules__<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    <span class="token comment">/* webpack/runtime/ensure chunk */</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        __webpack_require__<span class="token punctuation">.</span>f <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// This file contains only the entry chunk.</span>
        <span class="token comment">// The chunk loading function for additional chunks</span>
        __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
                Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promises<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    __webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">,</span> promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> promises<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* webpack/runtime/jsonp chunk loading */</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// object to store loaded and loading chunks</span>
        <span class="token comment">// undefined = chunk not loaded, null = chunk preloaded/prefetched</span>
        <span class="token comment">// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded</span>
        <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">//...</span>

        <span class="token comment">// install a JSONP callback for chunk loading</span>
        <span class="token comment">// 执行 installedChunks 中的 resolve ， 让 import() 得以继续执行。</span>
        <span class="token comment">// 将 chunk 中含有的模块全部注册到__webpack_require__.m变量中。</span>
        <span class="token keyword">var</span> <span class="token function-variable function">webpackJsonpCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">parentChunkLoadingFunction<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> <span class="token punctuation">[</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">,</span> runtime<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>

            <span class="token comment">// add &quot;moreModules&quot; to the modules object,</span>
            <span class="token comment">// then flag all &quot;chunkIds&quot; as loaded and fire callback</span>
            <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>
                chunkId<span class="token punctuation">,</span>
                i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    __webpack_require__<span class="token punctuation">.</span>m<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">)</span> <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">runtime</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 这句代码在多入口项目中才有作用，</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentChunkLoadingFunction<span class="token punctuation">)</span> <span class="token function">parentChunkLoadingFunction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                    __webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                installedChunks<span class="token punctuation">[</span>chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 先把self[&quot;webpackChunkwebpack_cases&quot;]赋值给chunkLoadingGlobal</span>
        <span class="token keyword">var</span> chunkLoadingGlobal <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">[</span><span class="token string">&quot;webpackChunkwebpack_cases&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span>
            self<span class="token punctuation">[</span><span class="token string">&quot;webpackChunkwebpack_cases&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        chunkLoadingGlobal<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token function">webpackJsonpCallback</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 用webpackJsonpCallback函数拦截chunkLoadingGlobal的push方法</span>
        <span class="token comment">// 也就是说调用self[&quot;webpackChunkwebpack_cases&quot;]的push方法都会执行webpackJsonpCallback函数。</span>
        chunkLoadingGlobal<span class="token punctuation">.</span>push <span class="token operator">=</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            chunkLoadingGlobal<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>chunkLoadingGlobal<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 从入口开始，递归读取依赖模块</span>
    <span class="token comment">// startup</span>
    <span class="token comment">// Load entry module and return exports</span>
    <span class="token comment">// This entry module can't be inlined because the eval devtool is used.</span>
    <span class="token keyword">var</span> __webpack_exports__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从以上来看，webpack 主要做的事情有：</p> <ol><li>读取入口文件，并收集依赖信息</li> <li>递归地读取所有依赖模块，产出完整的依赖列表</li> <li>将各模块内容打包成一块完整的可运行代码</li></ol> <p>其中涉及：</p> <ol><li><code>@babel/parser</code>用于解析源代码，产出 AST</li> <li><code>@babel/traverse</code> 用于遍历 AST，找到 require 语句并修改成 <em>require</em>，将引入路径改造为相对根的路径</li> <li><code>@babel/core</code> 用于将修改后的 AST 转换成新的代码输出</li></ol> <p>针对动态引入的模块， 会另外打包出一个 chunk，并且在源代码中通过<code>__webpack_require__.e</code>引入，这个函数主要做的事情：</p> <ol><li>设置 chunk 加载的三种状态并缓存在 installedChunks 中，防止 chunk 重复加载：
<ul><li>installedChunks[chunkId]为 0，代表该 chunk 已经加载完毕。</li> <li>installedChunks[chunkId]为 undefined，代表该 chunk 加载失败、加载超时、从未加载过。</li> <li>installedChunks[chunkId]为 Promise 对象，代表该 chunk 正在加载。</li></ul></li> <li>假如没加载过，则发起一个 JSONP 请求去加载 chunk</li> <li>处理 chunk 加载超时和加载出错的场景。</li></ol> <h2 id="webpack-的构建流程"><a href="#webpack-的构建流程" class="header-anchor">#</a> webpack 的构建流程</h2> <h3 id="初始化阶段-compile"><a href="#初始化阶段-compile" class="header-anchor">#</a> 初始化阶段（compile）</h3> <h4 id="step1-初始化参数"><a href="#step1-初始化参数" class="header-anchor">#</a> Step1：初始化参数</h4> <p>结合默认配置文件、配置对象和 shell 命令参数，得出最终的配置参数。</p> <h4 id="step2-创建编译器对象-compiler"><a href="#step2-创建编译器对象-compiler" class="header-anchor">#</a> Step2：创建编译器对象 Compiler</h4> <p>用配置参数创建编译器对象，Compiler 负责文件监听和启动编译。</p> <p>Compiler 实例中包含了完整的 Webpack 配置，全局只有一个 Compiler 实例，Compiler 将贯穿整个 webpack 构建过程，直到运行结束。</p> <h4 id="step3-初始化编译环境"><a href="#step3-初始化编译环境" class="header-anchor">#</a> Step3：初始化编译环境</h4> <p>包括注入内置插件、注册各种模块工厂、初始化 RuleSet 集合、加载配置的插件等。</p> <ul><li><p>注入内置插件：<br>
webpack 内置了数百个插件，这些插件并不需要我们手动配置，而是通过 WebpackOptionsApply 类会在初始化阶段根据配置内容动态注入对应的插件。其中包括：</p> <ul><li>EntryOptionPlugin 插件，处理 entry 配置；</li> <li>根据 devtool 值判断后续用哪个插件处理 sourcemap；</li> <li>注入 RuntimePlugin ，用于根据代码内容动态注入 webpack 运行时</li> <li>...</li></ul></li> <li><p>加载插件:<br>
会依次调用插件的 apply 方法，让插件可以监听后续的所有事件节点。同时给插件传入 compiler 实例的引用，以方便插件通过 compiler 调用 Webpack 提供的 API。</p></li></ul> <h4 id="step4-开始编译-compiler-run"><a href="#step4-开始编译-compiler-run" class="header-anchor">#</a> Step4：开始编译 compiler.run</h4> <p>相应的环境参数预设好了，接着执行 compiler 对象的 run 方法。</p> <p>其中，run 方法会触发 compiler.compile，接着进一步。</p> <p>这里会创建 compilation，compilation 代表一次单一的版本构建和生成资源。compilation 编译作业可以多次执行，比如 webpack 工作在 watch 模式下，每次监测到源文件发生变化时，都会重新实例化一个 compilation 对象。</p> <p>一个 compilation 对象表现了当前的模块资源、编译生成资源和被跟踪依赖的状态信息。</p> <h4 id="step5-确认入口"><a href="#step5-确认入口" class="header-anchor">#</a> Step5：确认入口</h4> <p>根据配置中的 entry 找出所有的入口文件，调用 compilition.addEntry 将入口文件转换为 dependence 对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 取自 lib/webpack.js：</span>
<span class="token comment">// https://github.com/webpack/webpack/blob/2151f56ae7/lib/webpack.js#L57</span>

<span class="token comment">// Step0: 启动 webpack ，触发 lib/webpack.js 文件中 createCompiler 方法</span>
<span class="token keyword">const</span> <span class="token function-variable function">webpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token comment">// 如果传入callback函数，则自启动</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">// Step4: 执行compiler.run / compiler.watch(watch模式下)</span>
        <span class="token comment">// 相关详细源码可见：https://github.com/webpack/webpack/blob/ad1c80214d30676edcf83cb8f74135646ced9cc8/lib/webpack.js#L133</span>
        <span class="token comment">// 在run函数中出现的钩子有：beforeRun --&gt; run --&gt; done --&gt; afterDone，第三方插件可以钩住不同的生命周期，接收compiler对象，处理不同逻辑。</span>
        compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> states</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

          <span class="token comment">// compiler.run方法会触发compiler.compile（和Step5有关，往下看）</span>
           compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err2</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">callbacl</span><span class="token punctuation">(</span>err <span class="token operator">||</span> err2<span class="token punctuation">,</span> states<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> compiler
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">createCompiler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rawOptions</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// webpack内部会有一个默认的配置，在 webpack.js入口处理函数中，初始化了所有的默认配置。</span>
    <span class="token comment">// 主要有三种对模块的默认配置，输出output，解析optimization，加载resolve模块以及resolveLoader。</span>

    <span class="token comment">// Step1: getNormalizedWebpackOptions 和 applyWebpackOptionsBaseDefaults 合并出最终配置（WebpackOptionsDefaulter里的逻辑）</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">getNormalizedWebpackOptions</span><span class="token punctuation">(</span>rawOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">applyWebpackOptionsBaseDefaults</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step2: 用配置参数创建编译器对象，Compiler 实例中包含了完整的 Webpack 配置</span>
    <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>

    <span class="token comment">// 插件通过apply接受compiler参数</span>
    <span class="token keyword">new</span> <span class="token class-name">NodeEnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">infrastructureLogging</span><span class="token operator">:</span> options<span class="token punctuation">.</span>infrastructureLogging<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 依次调用插件的 apply 方法，让插件可以监听后续的所有事件节点</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">applyWebpackOptionsDefaults</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterEnvironment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step3：初始化编译环境，根据配置内容动态注入对应的插件</span>
    <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> compiler<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 取自 lib/WebpackOptionsApply.js：</span>
<span class="token comment">// https://github.com/webpack/webpack/blob/2151f56ae73b35722c56432c9b34820626d72e53/lib/WebpackOptionsApply.js#L278</span>
<span class="token comment">// Step3-1: 调用 new WebpackOptionsApply().process 方法，注入各种内置插件</span>
<span class="token comment">// EntryOptionPlugin内部的apply方法，会注入EntryPlugin，EntryPlugin 监听 compiler.make 钩子（和Step5有关）</span>
<span class="token keyword">new</span> <span class="token class-name">EntryOptionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">entryOption</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">,</span> options<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 相关源码可见：</span>
<span class="token comment">// EntryOptionPlugin：</span>
<span class="token comment">// https://github.com/webpack/webpack/blob/2151f56ae73b35722c56432c9b34820626d72e53/lib/EntryOptionPlugin.js#L18</span>
<span class="token comment">// EntryPlugin：</span>
<span class="token comment">// https://github.com/webpack/webpack/blob/2151f56ae73b35722c56432c9b34820626d72e53/lib/EntryPlugin.js#L33</span>

<span class="token comment">// Step3-2：注入 RuntimePlugin，用于根据代码内容动态注入 webpack 运行时</span>
<span class="token keyword">new</span> <span class="token class-name">RuntimePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Step3-3: 根据 devtool 值判断后续用那个插件处理 sourcemap</span>
<span class="token comment">// EvalSourceMapDevToolPlugin 、SourceMapDevToolPlugin、EvalDevToolModulePlugin</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>devtool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;source-map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hidden <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;hidden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> inline <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;inline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> evalWrapped <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;eval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> cheap <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;cheap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> moduleMaps <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> noSources <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;nosources&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> Plugin <span class="token operator">=</span> evalWrapped
            <span class="token operator">?</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./EvalSourceMapDevToolPlugin&quot;</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./SourceMapDevToolPlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> inline <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>sourceMapFilename<span class="token punctuation">,</span>
            <span class="token literal-property property">moduleFilenameTemplate</span><span class="token operator">:</span>
                options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolModuleFilenameTemplate<span class="token punctuation">,</span>
            <span class="token literal-property property">fallbackModuleFilenameTemplate</span><span class="token operator">:</span>
                options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolFallbackModuleFilenameTemplate<span class="token punctuation">,</span>
            <span class="token literal-property property">append</span><span class="token operator">:</span> hidden <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> moduleMaps <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> cheap <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">columns</span><span class="token operator">:</span> cheap <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">noSources</span><span class="token operator">:</span> noSources<span class="token punctuation">,</span>
            <span class="token literal-property property">namespace</span><span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolNamespace<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;eval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> EvalDevToolModulePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./EvalDevToolModulePlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">EvalDevToolModulePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">moduleFilenameTemplate</span><span class="token operator">:</span>
                options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolModuleFilenameTemplate<span class="token punctuation">,</span>
            <span class="token literal-property property">namespace</span><span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolNamespace<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取自 lib/compiler.js</span>
<span class="token comment">// 在compile函数中出现的钩子有：beforeCompile --&gt; compile --&gt; make --&gt; afterCompile</span>
<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// compilation记录本次编译作业的环境信息</span>
        <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Step5：触发make钩子，这时候会触发EntryPlugin调用addEntry，找到入口</span>
        <span class="token comment">// 其中make就是我们关心的编译过程。在这里它仅是一个钩子触发，真正的编译执行是注册在这个钩子的回调上面（封装在各种插件里面的逻辑）</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>finishMake<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// ...</span>
                process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    compilation<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 封装构建结果（seal），逐次对每个module和chunk进行整理，每个chunk对应一个入口文件</span>
                        compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                <span class="token comment">// 异步的事件需要在插件处理完任务时调用回调函数通知 Webpack 进入下一个流程，</span>
                                <span class="token comment">// 不然运行流程将会一直卡在这不往下执行</span>
                                <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 this.addEntry 函数表示正式开始触发构建内容。</p> <p>在 Step5 触发了<code>this.hooks.make.callAsync</code>后，会触发 EntryPlugin 调用 addEntry，再进一步触发以下逻辑：<br> <code>this.addEntry --&gt; this._addEntryItem -&gt; this.addModuleTree --&gt; this.handleModuleCreation --&gt; this.factorizeModule --&gt; this.addModule --&gt; this.buildModule --&gt; this._buildModule --&gt; module.build...</code></p> <h3 id="构建阶段-make"><a href="#构建阶段-make" class="header-anchor">#</a> 构建阶段（make）</h3> <h4 id="step1-编译模块"><a href="#step1-编译模块" class="header-anchor">#</a> Step1：编译模块</h4> <p>进入 make 阶段，即触发 compilation.hooks.make 钩子，从 entry 出发开始编译模块，其中会根据模块资源类型调用对应的 loader 进行转译，然后生成 AST，再遍历 AST 去收集依赖。</p> <p>根据模块间的引用关系，逐步递归构建出模块依赖关系图(ModuleDependencyGraph)，依赖关系图表达了模块与模块之间互相引用的先后次序。</p> <h4 id="step2-处理依赖关系图-完成模块编译。"><a href="#step2-处理依赖关系图-完成模块编译。" class="header-anchor">#</a> Step2：处理依赖关系图，完成模块编译。</h4> <p>上一步递归处理所有能触达到的模块后，得到了每个模块被翻译后的内容以及它们之间的依赖关系图。</p> <p>基于依赖关系图， webpack 就可以推断出模块运行之前需要先执行那些依赖模块，也就可以进一步推断出哪些模块应该打包在一起，哪些模块可以延后加载(异步执行)。</p> <h4 id="细节展开"><a href="#细节展开" class="header-anchor">#</a> 细节展开</h4> <p>构建过程引入来自<a href="https://juejin.cn/post/6949040393165996040#heading-4" target="_blank" rel="noopener noreferrer">文杰大佬文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的图和文字描述：<br> <img src="https://ftp.bmp.ovh/imgs/2021/05/be14dbb967ae8fdd.png" alt=""></p> <blockquote><p><code>Dependency</code>：在模块中引用其它模块，例如 import &quot;a.js&quot; 语句，webpack 会先将引用关系表述为 Dependency 子类并关联 module 对象，等到当前 module 内容都解析完毕之后，启动下次循环开始，将 Dependency 对象转换为适当的 Module 子类。</p></blockquote> <blockquote><p><code>ModuleGraph</code> 对象通过 <code>_dependencyMap</code> 属性记录 <code>Dependency</code> 对象与 <code>ModuleGraphConnection（originModule/module）</code> 连接对象之间的映射关系，后续的处理中可以基于这层映射迅速找到 <strong>Dependency 实例对应的引用与被引用者</strong></p></blockquote> <blockquote><p><code>ModuleGraph</code> 对象通过 <code>_moduleMap</code> 在 <code>module</code> 基础上附加 <code>ModuleGraphModule</code> 信息，而 <code>ModuleGraphModule（incomingConnections表示谁引用了自己/outgoingConnections表示自己引用了谁）</code> 最大的作用就是记录了<strong>模块的引用与被引用关系</strong>，后续的处理可以基于该属性找到 module 实例的所有依赖与被依赖关系</p></blockquote> <blockquote><p>依赖关系收集过程主要发生在两个节点：<code>addDependency</code>和<code>handleModuleCreation</code>：<br> <code>addDependency</code>： webpack 从模块内容中解析出引用关系后，创建适当的 Dependency 子类并调用该方法记录到 module 实例<br> <code>handleModuleCreation</code>：根据文件类型构建 module 子类</p></blockquote> <h4 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h4> <p>假设，有入口文件<code>index.js</code>，依赖<code>a.js</code>和<code>b.js</code>，其中<code>a.js</code>依赖<code>c.js</code>和<code>d.js</code>，那解析的过程可以分为以下步骤：</p> <ul><li><p>Step1: EntryPlugin 根据 entry 配置找到 index.js 文件，调用 <code>compilation.addEntry</code> 函数触发构建流程；</p></li> <li><p>Step2: 触发<code>handleModuleCreation</code>，通过<code>module.build</code> 对 module 进行编译；</p> <p><code>module.build</code>会生成了一个<code>module[index.js]</code>，及其依赖对象列表<code>dependence[a.js]</code>和<code>dependence[b.js]</code>;</p> <p>其中步骤包括：<br>
1）会调用<code>runLoaders</code> 转译 module 源文件内容，通常是从各类资源类型转译为 JavaScript 代码；(原因是 webpack 只识别 JS 模块，其他格式需要 loader 协助)</p> <p>2）调用 <code>acorn</code> 将 JS 文本解析为<code>AST</code>；</p> <p>相关代码 lib/NormalModule.js#L1004：<code>result = this.parser.parse(this._ast || this._source.source()</code>；</p> <p><code>this.parser</code>其实就是<code>JavascriptParser的实例对象</code>，JavascriptParser 会调用第三方包 acorn 的 parse 方法对 JS 代码进行语法解析成<code>AST</code>。（这里有可能在 loader 处理过程中就直接将文件转成 AST 了，这种情况会被保存到 <code>extraInfo.webpackAST</code> 中，然后在这一步就可直接复用，以避免重复生成 AST，提升性能。）</p> <p>3）遍历 AST，触发各种钩子，其中包括：</p> <ul><li><p>HarmonyImportDependencyParserPlugin 插件监听 <code>import</code> 和 <code>importSpecifier</code> 钩子，对依赖资源进行逻辑处理；</p></li> <li><p><strong>遇到 import/require 语句就增加相关依赖，调用 module 对象的<code>addDependency</code>将依赖对象加入到 module 依赖列表中。</strong></p></li></ul> <p>接下来就是对依赖列表进行处理。</p></li> <li><p>Step3： AST 遍历完，会回到 dobuild 回调，调用 handleParseResult。对于 module 新增的依赖再次调用 <code>handleModuleCreation</code>，控制流回到 Step2。</p> <p>调用<code>handleModuleCreation</code>方法创建 Dependency 对应的子模块对象，之后调用 <code>moduleGraph.setResolvedModule</code>将父子引用信息记录到 <code>moduleGraph</code> 对象上。</p> <p><code>module[index.js]</code> 的 handleParseResult 函数，继续处理 a.js、b.js 文件，递归上述流程，进一步得到 a、b 模块<code>module[a.js]</code>和<code>module[b.js]</code>； 接着，对<code>module[a.js]</code>也会进行收集依赖，得到其依赖对象列表<code>dependence[c.js]</code>和<code>dependence[d.js]</code>。</p></li></ul> <p>这个过程中，数据流<code>module =&gt; ast =&gt; dependencies =&gt; module</code> ，即先转 AST 再从中遍历找依赖。经过收集后的 ModuleGraph 结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">ModuleGraph</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_dependencyMap</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">3</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            EntryDependency<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphConnection<span class="token punctuation">{</span>
                <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">originModule</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">// 入口模块没有引用者，故设置为 null</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            HarmonyImportSideEffectDependency<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphConnection<span class="token punctuation">{</span>
                <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// b.js同理...</span>
        <span class="token punctuation">{</span>
            HarmonyImportSideEffectDependency<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/c.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphConnection<span class="token punctuation">{</span>
                <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/c.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// d.js同理...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token literal-property property">_moduleMap</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">3</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphModule<span class="token punctuation">{</span>
            <span class="token literal-property property">incomingConnections</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">[</span> <span class="token comment">// 谁引用了自己</span>
                <span class="token comment">// entry 模块，对应 originModule 为null</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span><span class="token keyword">null</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">outgoingConnections</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">[</span> <span class="token comment">// 自己引用了谁</span>
                <span class="token comment">// 从 index 指向 a 模块</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 从 index 指向 b 模块</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/b.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphModule<span class="token punctuation">{</span>
            <span class="token literal-property property">incomingConnections</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">outgoingConnections</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>
                <span class="token comment">// 从 a 指向 c 模块</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/c.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 从 a 指向 d 模块</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/d.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/b.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphModule<span class="token punctuation">{</span>
            <span class="token literal-property property">incomingConnections</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/b.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// b 模块没有其他依赖，故 outgoingConnections 属性值为 undefined</span>
            <span class="token literal-property property">outgoingConnections</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/c.js&quot;</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> ModuleGraphModule<span class="token punctuation">{</span>
            <span class="token literal-property property">incomingConnections</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>
                ModuleGraphConnection<span class="token punctuation">{</span> <span class="token literal-property property">module</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/c.js&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">originModule</span><span class="token operator">:</span> NormalModule<span class="token punctuation">{</span><span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token string">&quot;./src/a.js&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">outgoingConnections</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// d.js同理...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="生成阶段-seal"><a href="#生成阶段-seal" class="header-anchor">#</a> 生成阶段（seal）</h3> <p>至此，从入口文件开始，webpack 已经收集完整了模块的信息和依赖项，接下来就是如何进一步打包封装模块了。构建阶段围绕 module 展开，生成阶段则围绕 chunks 展开。</p> <p>chunks 生成的大概过程：<br>
1.webpack 首先会将 entry 中对应的 module 都生成一个新的 chunk。<br>
2.遍历 module 对应的依赖列表，将其依赖的模块也加入到 chunk 中。<br>
3.如果依赖的模块是动态引入的模块，会根据这个 module 创建一个新的 chunk，继续遍历依赖。<br>
4.重复上面的过程，直至得到所有的 chunk。</p> <h4 id="seal-过程"><a href="#seal-过程" class="header-anchor">#</a> seal 过程</h4> <p>seal 主要完成从 module 到 chunks 的转化，主要围绕 Chunk 及 ChunkGroup 两个类型展开。</p> <p>1）chunk，由 module 组成，一个 chunk 可以包含多个 module，它是 webpack 编译打包后输出的最终文件；<br>
2）chunkGroup，由 chunk 组成，一个 chunkGroup 可以包含多个 chunk，在生成/优化 ChunkGraph 时会用到。</p> <ul><li><p>Step1：根据 moduleGraph 构建本次编译的 chunkGraph 对象；</p></li> <li><p>Step2：遍历 compilation.modules 集合，对 entry 入口文件 和动态引入分配给不同的 Chunk 对象（生成 chunk）；</p></li> <li><p>Step3：createChunkAssets 遍历 module/chunk，把所有依赖项通过对应的模板 render 出一个拼接好的字符串；</p></li></ul> <blockquote><p>createChunkAssets 执行过程中，会优先读取 cache 中是否已经有了相同 hash 的资源，如果有，则直接返回内容，否则才会继续执行模块生成的逻辑，并存入 cache 中。<br>
seal 阶段经历了很多的优化，最终生成的代码会存放在 Compilation 的 assets 属性上。第三方 webpack 插件也很多会通过 compilation.assets 和 compilation.chunks 进行逻辑拓展。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 取自 lib/Compilation.js#L2235</span>
<span class="token comment">// 根据moduleGraph构建ChunkGraph</span>
<span class="token keyword">const</span> chunkGraph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkGraph</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>moduleGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ChunkGraph过程中会调用_getGraphRoots方法，通过 moduleGraph.getOutgoingConnections(module)查找 module 实例的所有依赖</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>chunkGraph <span class="token operator">=</span> chunkGraph<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ChunkGraph<span class="token punctuation">.</span><span class="token function">setChunkGraphForModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> chunkGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 遍历根据 addEntry 方法中收集到入口文件组成的this.entries数组</span>
<span class="token keyword">const</span> chunkGraphInit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span> dependencies<span class="token punctuation">,</span> includeDependencies<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每个入口 创建一个chunk</span>
    <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addChunk</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chunk<span class="token punctuation">.</span>filenameTemplate <span class="token operator">=</span> options<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 每一个 entryPoint 就是一个 chunkGroup</span>
    <span class="token keyword">const</span> entrypoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entrypoint</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>dependOn <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置 runtime chunk</span>
        <span class="token comment">// 同时内部会有个比较特殊的 runtimeChunk(当 webpack 最终编译完成后包含的webpack runtime代码最终会注入到 runtimeChunk当中)</span>
        entrypoint<span class="token punctuation">.</span><span class="token function">setRuntimeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    entrypoint<span class="token punctuation">.</span><span class="token function">setEntrypointChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置 chunkGroups 的内容</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>namedChunkGroups<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entrypoints<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 建立起 chunkGroup 和 chunk 之间的关系</span>
    <span class="token function">connectChunkGroupAndChunk</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>globalEntry<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>dependencies<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        entrypoint<span class="token punctuation">.</span><span class="token function">addOrigin</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">/** @type {any} */</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleGraph<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chunkGraph<span class="token punctuation">.</span><span class="token function">connectChunkAndEntryModule</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> module<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> modulesList <span class="token operator">=</span> chunkGraphInit<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>modulesList <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 构建了chunk 和入口 module 之间的联系</span>
                chunkGrphInit<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">,</span> <span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                modulesList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//  ...</span>

    <span class="token comment">// 取自 lib/Compilation.js#L3763</span>
    <span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">const</span> outputOptions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outputOptions<span class="token punctuation">;</span>
		<span class="token keyword">const</span> cachedSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/** @type {Map&lt;string, {hash: string, source: Source, chunk: Chunk}&gt;} */</span>
		<span class="token keyword">const</span> alreadyWrittenFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        asyncLib<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// manifest是数组结构，每个manifest元素都提供了 `render` 方法提供后续的源码字符串生成服务。</span>
                <span class="token comment">// 至于render方法何时初始化的，在`./lib/MainTemplate.js`中</span>
                <span class="token keyword">let</span> manifest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRenderManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                asyncLib<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>manifest<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">fileManifest<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token operator">...</span>
                        source <span class="token operator">=</span> fileManifest<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitAsset</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> source<span class="token punctuation">,</span> assetInfo<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    callback
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            callback
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>




    <span class="token comment">// todo 未完待续，回头继续分析</span>



</code></pre></div><h3 id="写入阶段-emit"><a href="#写入阶段-emit" class="header-anchor">#</a> 写入阶段（emit）</h3> <p>在 seal 执行后，关于模块所有信息以及打包后源码信息都存在内存中，也可以在传入事件回调的 compilation.assets 上拿到所需数据。</p> <p>此时控制流会回到 compiler 中，触发 emitAssets。函数内部调用 <code>compiler.outputFileSystem.writeFile</code> 方法，将 assets 集合根据 output 配置的 path 属性，将文件输出到指定的文件夹。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/Project Management/Webpack 基础扫盲.html" class="prev">
        👉 Webpack 基础扫盲
      </a></span> <span class="next"><a href="/articles/Project Management/Web性能优化.html">
        👉 Web 性能优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.448d156c.js" defer></script><script src="/assets/js/2.fefa3fa1.js" defer></script><script src="/assets/js/1.67a15f5a.js" defer></script><script src="/assets/js/63.3358d1e0.js" defer></script>
  </body>
</html>
