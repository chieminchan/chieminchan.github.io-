<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序上手篇 | CHIEMINCHAN&#39;S BLOG</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/donut.png">
    <meta name="description" content="Hi, glad you came.">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.448d156c.js" as="script"><link rel="preload" href="/assets/js/2.fefa3fa1.js" as="script"><link rel="preload" href="/assets/js/1.67a15f5a.js" as="script"><link rel="preload" href="/assets/js/52.50f1abf2.js" as="script"><link rel="prefetch" href="/assets/js/10.5229b01a.js"><link rel="prefetch" href="/assets/js/11.9dccb5a1.js"><link rel="prefetch" href="/assets/js/12.1aa023e7.js"><link rel="prefetch" href="/assets/js/13.da540175.js"><link rel="prefetch" href="/assets/js/14.981e669d.js"><link rel="prefetch" href="/assets/js/15.f28dd0b3.js"><link rel="prefetch" href="/assets/js/16.47e1d84d.js"><link rel="prefetch" href="/assets/js/17.7ff34030.js"><link rel="prefetch" href="/assets/js/18.6dcbdd16.js"><link rel="prefetch" href="/assets/js/19.e568fd00.js"><link rel="prefetch" href="/assets/js/20.182f1f9b.js"><link rel="prefetch" href="/assets/js/21.b834a74a.js"><link rel="prefetch" href="/assets/js/22.a3523cd2.js"><link rel="prefetch" href="/assets/js/23.61d15c5b.js"><link rel="prefetch" href="/assets/js/24.2aadb209.js"><link rel="prefetch" href="/assets/js/25.836695fb.js"><link rel="prefetch" href="/assets/js/26.0ab922cb.js"><link rel="prefetch" href="/assets/js/27.5ac9e339.js"><link rel="prefetch" href="/assets/js/28.d6a5eb15.js"><link rel="prefetch" href="/assets/js/29.3eea682e.js"><link rel="prefetch" href="/assets/js/3.fc739620.js"><link rel="prefetch" href="/assets/js/30.5225944d.js"><link rel="prefetch" href="/assets/js/31.ec02d3da.js"><link rel="prefetch" href="/assets/js/32.bd05dede.js"><link rel="prefetch" href="/assets/js/33.4a293dcf.js"><link rel="prefetch" href="/assets/js/34.4464026b.js"><link rel="prefetch" href="/assets/js/35.4dd4f327.js"><link rel="prefetch" href="/assets/js/36.ca28dda7.js"><link rel="prefetch" href="/assets/js/37.3a17971f.js"><link rel="prefetch" href="/assets/js/38.f86fa51b.js"><link rel="prefetch" href="/assets/js/39.6ff149b0.js"><link rel="prefetch" href="/assets/js/4.0471e9ae.js"><link rel="prefetch" href="/assets/js/40.23565895.js"><link rel="prefetch" href="/assets/js/41.0116a1ec.js"><link rel="prefetch" href="/assets/js/42.c38f3e0c.js"><link rel="prefetch" href="/assets/js/43.1d0d8ffd.js"><link rel="prefetch" href="/assets/js/44.631fa43e.js"><link rel="prefetch" href="/assets/js/45.0f88df1f.js"><link rel="prefetch" href="/assets/js/46.cc671ab0.js"><link rel="prefetch" href="/assets/js/47.90cce12d.js"><link rel="prefetch" href="/assets/js/48.ad0ce6a4.js"><link rel="prefetch" href="/assets/js/49.ade35f37.js"><link rel="prefetch" href="/assets/js/5.5356be46.js"><link rel="prefetch" href="/assets/js/50.de00c31b.js"><link rel="prefetch" href="/assets/js/51.9de8257a.js"><link rel="prefetch" href="/assets/js/53.b3b3acb2.js"><link rel="prefetch" href="/assets/js/54.71bfe1b2.js"><link rel="prefetch" href="/assets/js/55.b00cfb1c.js"><link rel="prefetch" href="/assets/js/56.1bb058d3.js"><link rel="prefetch" href="/assets/js/57.5651fd65.js"><link rel="prefetch" href="/assets/js/58.3dd11306.js"><link rel="prefetch" href="/assets/js/59.233d45e8.js"><link rel="prefetch" href="/assets/js/6.5b3d5499.js"><link rel="prefetch" href="/assets/js/60.7c729149.js"><link rel="prefetch" href="/assets/js/61.eb5805f6.js"><link rel="prefetch" href="/assets/js/62.fde12179.js"><link rel="prefetch" href="/assets/js/63.3358d1e0.js"><link rel="prefetch" href="/assets/js/64.1b930210.js"><link rel="prefetch" href="/assets/js/65.3048ba53.js"><link rel="prefetch" href="/assets/js/66.a065502e.js"><link rel="prefetch" href="/assets/js/67.715eef17.js"><link rel="prefetch" href="/assets/js/68.edf44196.js"><link rel="prefetch" href="/assets/js/69.94cb6d60.js"><link rel="prefetch" href="/assets/js/7.c94df317.js"><link rel="prefetch" href="/assets/js/70.9061bb98.js"><link rel="prefetch" href="/assets/js/71.980c8e32.js"><link rel="prefetch" href="/assets/js/72.43be58ba.js"><link rel="prefetch" href="/assets/js/73.e2f40377.js"><link rel="prefetch" href="/assets/js/74.9ef8a48c.js"><link rel="prefetch" href="/assets/js/75.b006fb40.js"><link rel="prefetch" href="/assets/js/76.311cf38f.js"><link rel="prefetch" href="/assets/js/77.2d4b2c6d.js"><link rel="prefetch" href="/assets/js/78.81fd1ead.js"><link rel="prefetch" href="/assets/js/79.01e24fba.js"><link rel="prefetch" href="/assets/js/80.b15cc1f3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.934ed2fb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">CHIEMINCHAN'S BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  知识碎片
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读/观后感
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/fragments/" class="nav-link">
  知识碎片
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读/观后感
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chieminchan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DesignPatterns</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Microapp</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/Microapp/小程序上手篇.html" class="active sidebar-link">小程序上手篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#小程序的出现" class="sidebar-link">小程序的出现</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#小程序定义" class="sidebar-link">小程序定义</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#整体结构" class="sidebar-link">整体结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#双线程架构" class="sidebar-link">双线程架构</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#多-webview-结构模式" class="sidebar-link">多 WebView 结构模式</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#如此设计原因" class="sidebar-link">如此设计原因</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#运行环境" class="sidebar-link">运行环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#三类运行环境" class="sidebar-link">三类运行环境</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#基础库" class="sidebar-link">基础库</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#宿主-app、小程序运行容器-sdk、基础库三者构成小程序的运行环境" class="sidebar-link">宿主 APP、小程序运行容器 SDK、基础库三者构成小程序的运行环境</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#如何兼容" class="sidebar-link">如何兼容</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#前-后台状态-销毁时机" class="sidebar-link">前/后台状态 &amp; 销毁时机</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#更新策略" class="sidebar-link">更新策略</a></li><li class="sidebar-sub-header"><a href="/articles/Microapp/小程序上手篇.html#参考文章" class="sidebar-link">参考文章：</a></li></ul></li><li><a href="/articles/Microapp/小程序性能篇.html" class="sidebar-link">小程序性能篇</a></li><li><a href="/articles/Microapp/小程序渲染原理篇.html" class="sidebar-link">小程序渲染原理篇</a></li><li><a href="/articles/Microapp/小程序运行原理篇.html" class="sidebar-link">小程序运行原理篇</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Project Management</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="小程序上手篇"><a href="#小程序上手篇" class="header-anchor">#</a> 小程序上手篇</h1> <blockquote><p>本文主要记录笔者上手字节小程序开发过程中的一些学习总结，知识的搬运工，对某些知识点的理解可能不够深入或存在偏颇，欢迎多多指教。</p></blockquote> <h2 id="小程序的出现"><a href="#小程序的出现" class="header-anchor">#</a> 小程序的出现</h2> <ul><li><p>原生 App 应用和 H5 页面</p> <ul><li>最初的移动客户端开发方式主要有原生 APP 应用开发和 H5 纯页面开发</li> <li>原生 App 功能强大，消息推送及时，体验好，但开发迭代成本高，每次版本更新需要用户手动下载新版本；</li> <li>H5 页面相对原生 APP 功能少，体验稍差，但开发成本低，用户对迭代更新感知度相对低</li></ul> <p><img src="https://s4.ax1x.com/2021/12/12/obh2o8.png" alt="obh2o8.png"></p></li> <li><p>Hyprid App（APP 内置 H5 页面）</p> <ul><li>在移动端原生应用的基础上，通过 JSBrdige 等方法，访问原生应用的 API 进行 JS 的交互，并通过 WebView 等技术实现 HTML 与 CSS 的渲染。WebView 可以理解为嵌套了一个浏览器内核（比如 webkit）的移动端组件。</li> <li>一定程度上，减少了原生 APP 体积和降低迭代更新频率</li></ul></li> <li><p>微信公众号</p> <ul><li>用户不愿意再下载更多新的 App，越来越倾向于在大流量 App 里获取一切服务</li> <li>公众号是小程序的“前身”，当时，企业们普遍会把 H5 网站放在公众号作为流量转换的入口</li> <li>公众号的出现使得 WebView 使用频率越来越高，微信团队还提供了 JS-SDK，提供了拍摄、录音、语音识别、二维码、地图、支付、分享等能力，开发者都可以使用到微信的原生能力</li> <li>但是 JS-SDK 并没有完全解决使用移动页面的一些交互体验问题，比如受限于网络或者设备性能影响出现白屏，页面切换效果生硬或者点击迟滞感</li></ul></li> <li><p>2017 年 1 月 9 日，微信小程序正式发布上线。小程序的产品理念：“用完即走”；小程序的定位：“体验比网站好，比下载 APP 更便捷。”</p> <blockquote><p>微信并不是第一个做小程序的 App，而是做小程序最有优势的 App，比如高流量、用户较长的停留时间等等。站在微信的视角，从业务形式上看，小程序更像是公众号开发演变产物。在更早的时候，微信通过 sdk 的形式，增强了开发者开发公众号网页的能力。小程序的诞生是微信本身迈向平台化的业务行为，并且帮助用户更好的实现了「轻量级 Web App」。</p></blockquote></li> <li><p>2018 年微信小程序 “跳一跳” 爆火，助力了微信小程序在用户中的扩张，也激发了其他厂商开发小程序的热潮。</p> <ul><li>基于小程序几乎相同的技术原理，以及小程序的方便快捷的特性，还衍生出了多款小程序，比如抖音小程序、快手小程序、京东小程序、美团小程序等，帮助各大厂商更好的为用户提供便捷的服务。</li></ul> <p><img src="https://s4.ax1x.com/2021/12/12/obhgdf.png" alt="obhgdf.png"></p></li></ul> <h2 id="小程序定义"><a href="#小程序定义" class="header-anchor">#</a> 小程序定义</h2> <ul><li><p>小程序的叫法其实主要从微信开始， 指的是不需要下载安装即可使用的应用，它实现了应用“触手可及”，也就是用户可以通过扫一扫或搜一下即可打开的应用。</p></li> <li><p>小程序是平台方为了扩展和丰富生态，给开发者提供的供用户使用的可即时打开的一种应用形态。</p></li> <li><p>字节小程序身处大的开发者生态之中，基于字节 APP 而建，围绕开放场景、开放接口、开放信任关系搭建的一套平台化 SDK，整套解决方案框架如下：</p></li></ul> <p><img src="https://s4.ax1x.com/2021/12/12/oq8839.md.jpg" alt="oq8839.md.jpg"></p> <p>（此图来源：https://zhuanlan.zhihu.com/p/437664188 ）</p> <h2 id="整体结构"><a href="#整体结构" class="header-anchor">#</a> 整体结构</h2> <p>小程序是 Hybrid 应用，结合了客户端原生技术和 Web 技术的各自特点，即界面主要由成熟的 Web 技术渲染，然后提供大量访问客户端端上原生能力的 API，使得小程序比普通页面拥有更多的能力，同时，每个小程序页面用不同的 WebView 去渲染，以此提供贴近原生的交互体验，也避免了单个 WebView 任务过于繁重。</p> <p><img src="https://s4.ax1x.com/2021/12/12/obLbjO.md.png" alt="obLbjO.md.png"></p> <h3 id="双线程架构"><a href="#双线程架构" class="header-anchor">#</a> 双线程架构</h3> <p>小程序的底层架构基于双线程，即小程序的逻辑层与渲染层分开在不同的线程运行，互不干扰。</p> <ul><li><p>渲染层：一般又称为 WebView 侧，依赖宿主创建的 WebView 线程，负责渲染小程序页面，包括 Web 组件渲染和原生组件渲染，可以认为是 webview + nativeview 组件混合渲染方式。</p></li> <li><p>逻辑层：一般又称为 AppService 侧，依赖客户端创建的一个单独 JSCore 线程，负责解释与执行开发者编写的 JS 代码，比如：事件处理、API 调用和生命周期管理等。</p></li></ul> <h3 id="多-webview-结构模式"><a href="#多-webview-结构模式" class="header-anchor">#</a> 多 WebView 结构模式</h3> <p>双线程最基础的架构模型，而渲染层中则是需要多 WebView 结构的。因为一般小程序都是多页应用，如果渲染层只有一条线程，显然不够用，这时就需要维护多个 WebView 以此来保障页面切换时有流畅的过渡效果。</p> <h3 id="如此设计原因"><a href="#如此设计原因" class="header-anchor">#</a> 如此设计原因</h3> <ul><li><p>纯原生 APP 和 H5 页面 各有千秋，融合两者特点：</p> <ul><li><p>如果用纯客户端原生技术来编写小程序，那小程序代码需要与客户端代码一起编包，跟随发版本，用户对频繁迭代更新的节奏比较敏感；</p></li> <li><p>浏览器纯 web 的渲染方式虽然可以加载云端资源，通过下载到本地，动态执行后渲染出界面。但是在一些复杂交互的场景，界面上可能需要使用宿主端上的一些原生能力，同时也可能会面临一些性能问题。</p></li></ul></li> <li><p>在小程序中，不同页面由不同的 WebView 渲染后显示，然后将所有的页面、组件的逻辑收在一个线程里，比较方便完成数据状态共享。</p></li> <li><p>提供安全与管控的沙盒环境</p> <p>小程序是基于 Web 技术的，如果没有进行隔离，开发者可以直接通过 JS 操作界面的 DOM，那么一些敏感数据将会毫无安全性可言（尤其 eval、new Function()这类比较灵活的 API），因此需要提供一个沙箱环境来隔离运行开发者的 JS 代码，这个环境不会有任何的浏览器相关的接口。</p></li></ul> <p>小程序目前采用 webview + native 的方式，是围绕目标定位最简单有效的方式，即依赖于 Web 技术，又能融合应用功能。尽管目前看来，这套方案在渲染效率上，其实并不比 RN 和 Weex 的原生渲染方式或者 Flutter 使用 Dart 语言的自渲染方式占优势。</p> <h2 id="运行环境"><a href="#运行环境" class="header-anchor">#</a> 运行环境</h2> <h3 id="三类运行环境"><a href="#三类运行环境" class="header-anchor">#</a> 三类运行环境</h3> <p>小程序主要有三类运行环境，不同的运行环境，有着不同的 JS 引擎和界面渲染环境：</p> <ul><li>iOS 逻辑层 JS 代码运行在 JSCore 中，视图层由 WKWebView 内核渲染</li> <li>Android 逻辑层 JS 代码运行在 V8，视图层由 Mobile Chrome 内核来渲染的</li> <li>开发者工具逻辑层的 JavaScript 代码是运行在 NW.js 中，视图层是由 Chromium Webview 来渲染的。其中，小程序主要依赖于客户端上运行，开发者工具仅供调试使用，最终表现以客户端为准。</li></ul> <h3 id="基础库"><a href="#基础库" class="header-anchor">#</a> 基础库</h3> <p>小程序的基础库是 JavaScript 编写的，负责处理数据绑定、组件系统、事件系统、通信系统等一系列框架逻辑。由于小程序的渲染层和逻辑层是两个线程管理，因此在宿主创建小程序容器时，会分别往两个线程注入基础库。一般来说：</p> <ul><li>在逻辑层，基础库主要负责初始化应用整体框架 js 代码，加载业务逻辑 js</li> <li>在渲染层，基础库主要负责处理渲染相关逻辑，比如：diff 处理、定义页面相关事件的触发等</li></ul> <p>对于开发者工具来说，它并不是真正意义上的移动客户端，并没有 Native。它实质是通过 Websocket 进行线程与线程之间的通讯，并在基础库中对 JSBridge 提供的通信方法基础上进行重构兼容。</p> <h3 id="宿主-app、小程序运行容器-sdk、基础库三者构成小程序的运行环境"><a href="#宿主-app、小程序运行容器-sdk、基础库三者构成小程序的运行环境" class="header-anchor">#</a> 宿主 APP、小程序运行容器 SDK、基础库三者构成小程序的运行环境</h3> <ul><li><p>宿主 APP 接入了小程序运行容器 SDK 后，需要实现必要基础功能（宿主启动进程运行小程序 SDK、支持小程序 SDK 与端上的通信和参数传递等等），同时，也可以按需扩展一些高级功能。</p></li> <li><p>基础库内置于宿主，与 SDK 结合，提供 JSBridge 能力。</p></li> <li><p>基础库的更新能力收敛在 SDK 内，并支持动态下发。（宿主在预加载场景和初始场景情况下均会触发基础更新检查，以保证基础库及时下发）</p></li> <li><p>不同客户端对不同的小程序 SDK 版本和基础库版本，多宿主的差异可以在基础库结合小程序 SDK 上做差异抹平和规避。</p></li></ul> <h3 id="如何兼容"><a href="#如何兼容" class="header-anchor">#</a> 如何兼容</h3> <p>开放平台提供的 API 和基础库版本有独立且规范的版本对应关系，不同版本的客户端集成了不同版本的基础库，因此小程序运行过程中可能存在一定的差异，因此在开发中需要注意兼容问题。一般可以通过版本号比较、API 存在判断、tt.canIUse 等几种方式进行兼容处理。另外也可以在开平上设置最低基础库版本。</p> <ul><li><p>版本号比较开发过程中，留意官方文档给出的 API 或者属性参数支持最低版本；通过 <code>tt.getSystemInfo</code> 得到 SDKVersion，与最低版本号比较。SDKVersion 由[大版本].[小版本].[修订版本]三部分组成，例如：1.11.1。</p></li> <li><p>API 存在判断</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>tt<span class="token punctuation">.</span>setTabBarStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tt<span class="token punctuation">.</span><span class="token function">setTabBarStyle</span><span class="token punctuation">(</span><span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    tt<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;提示&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&quot;当前客户端版本过低，请升级客户端&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>tt.canIUse</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>tt<span class="token punctuation">.</span><span class="token function">canIUse</span><span class="token punctuation">(</span><span class="token string">&quot;setTabBarStyle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tt<span class="token punctuation">.</span><span class="token function">setTabBarStyle</span><span class="token punctuation">(</span><span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    tt<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;提示&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&quot;当前客户端版本过低，请升级客户端&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>配置小程序最低的基础库版本进入开发者后台的设置页，选择 JSSDK 最低版本号（注意受影响用户占比）</li></ul> <h2 id="前-后台状态-销毁时机"><a href="#前-后台状态-销毁时机" class="header-anchor">#</a> 前/后台状态 &amp; 销毁时机</h2> <ul><li>用户首次打开小程序时，或小程序销毁后被用户再次打开，会重新创建小程序的逻辑层与视图层，并装载小程序。（冷启动）</li> <li>小程序被用户打开过后，用户退出小程序，小程序并未销毁，只是暂存于后台。当用户再次点击调起小程序，小程序不会重新创建逻辑层与视图层，只是将后台的小程序进行了展示。（热启动）</li> <li>小程序无刷新概念，刷新重启会将小程序销毁，然后重新创建小程序（也就是新的一轮冷启）</li> <li>安卓上，小程序在被用户关闭后，并不会直接销毁，而是退到后台 IOS 上，小程序在被用户点击胶囊按钮关闭后（或者返回退出），会直接销毁</li> <li>当小程序进入后台一定时间，或者占用系统资源过高会被系统销毁，或被小程序 SDK 主动回收安卓上，小程序进程新增到第 5 个时，会将第 1 个小程序进程销毁掉，重新加载成空的</li> <li>当运行小程序的客户端进程被杀死，客户端中后台的小程序进程也会被销毁</li></ul> <h2 id="更新策略"><a href="#更新策略" class="header-anchor">#</a> 更新策略</h2> <p>小程序每次冷启动都会优先使用本地已经缓存的程序包启动小程序。同时，会异步检查是否有更新版本。如果发现有新版本，将会异步下载新版本的代码包。因此新的代码包默认是在下一次冷启动时才会应用。</p> <p>如果需要在发布后马上应用最新版本，可以使用<code>tt.getUpdateManager</code>在每次启动小程序时获取版本情况。在版本更新时弹窗提醒用户进行重启更新。</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token keyword">var</span> updateManager <span class="token operator">=</span> tt<span class="token punctuation">.</span><span class="token function">getUpdateManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    updateManager<span class="token punctuation">.</span><span class="token function">onUpdateReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      tt<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;更新提示&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&quot;新版本已经准备好，是否重启小程序？&quot;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 新的版本已经下载好，调用 applyUpdate 应用新版本并重启</span>
            updateManager<span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    updateManager<span class="token punctuation">.</span><span class="token function">onUpdateFailed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新的版本下载失败</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;版本下载失败原因&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;新版本下载失败，请稍后再试&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章：</h2> <ul><li><p><a href="https://www.zhihu.com/question/446103629" target="_blank" rel="noopener noreferrer">知乎上的一个话题：微信小程序的双线程设计有何创新之处？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://microapp.bytedance.com/docs/zh-CN/mini-app/develop/guide/start/introduction" target="_blank" rel="noopener noreferrer">字节小程序官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/JavaScript/防抖和节流.html" class="prev">
        👉 防抖和节流
      </a></span> <span class="next"><a href="/articles/Microapp/小程序性能篇.html">
        小程序性能篇
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.448d156c.js" defer></script><script src="/assets/js/2.fefa3fa1.js" defer></script><script src="/assets/js/1.67a15f5a.js" defer></script><script src="/assets/js/52.50f1abf2.js" defer></script>
  </body>
</html>
